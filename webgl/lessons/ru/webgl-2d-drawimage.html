<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/ru/webgl-2d-drawimage.md. Do not edited directly -->
<!--
Copyright 2021, GFXFundamentals.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of GFXFundamentals. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Как реализовать функцию drawImage canvas 2d в WebGL">
<meta name="keywords" content="webgl webgl2 graphics">
<meta name="thumbnail" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-2d-drawimage_ru.jpg">

<meta property="og:title" content="WebGL2 Реализация DrawImage">
<meta property="og:type" content="website">
<meta property="og:image" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-2d-drawimage_ru.jpg">
<meta property="og:description" content="Как реализовать функцию drawImage canvas 2d в WebGL">
<meta property="og:url" content="https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@greggman">
<meta name="twitter:creator" content="@greggman">
<meta name="twitter:domain" content="webgl2fundamentals.org">
<meta name="twitter:title" content="WebGL2 Реализация DrawImage">
<meta name="twitter:url" content="https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html">
<meta name="twitter:description" content="Как реализовать функцию drawImage canvas 2d в WebGL">
<meta name="twitter:image:src" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-2d-drawimage_ru.jpg">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webgl2fundamentals.org/#website",
      "url":"https://webgl2fundamentals.org/",
      "name":"Webgl2Fundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html#primaryimage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-2d-drawimage_ru.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html#webpage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html",
      "inLanguage":"ru",
      "name":"WebGL2 Реализация DrawImage",
      "keywords":"webgl webgl2 graphics programming",
      "isPartOf":{
        "@id":"https://webgl2fundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webgl2fundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL2 Реализация DrawImage</title>
<link href="/webgl/lessons/resources/webgl2fundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/lang.css">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css">

  <link rel="alternate" hreflang="en" href="https://webglfundamentals.org/webgl/lessons/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="de" href="https://webglfundamentals.org/webgl/lessons/de/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="ja" href="https://webglfundamentals.org/webgl/lessons/ja/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="ko" href="https://webglfundamentals.org/webgl/lessons/ko/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="pt-br" href="https://webglfundamentals.org/webgl/lessons/pt-br/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="ru" href="https://webglfundamentals.org/webgl/lessons/ru/webgl-2d-drawimage.html">
  <link rel="alternate" hreflang="zh_cn" href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-drawimage.html">




</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-2d-drawimage.html" >English</a>
    <option value="/webgl/lessons/de/webgl-2d-drawimage.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-2d-drawimage.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-2d-drawimage.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-2d-drawimage.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/ru/webgl-2d-drawimage.html" selected>Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-2d-drawimage.html" >简体中文</a>
</select>


    <a href="#toc">Содержание</a>
    <input type="search" placeholder="?" id="search">
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/ru/">WebGL2Fundamentals.org</a></h1>
<style>
#forkongithub>div {
    background: #000;
    color: #fff;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 1.3rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 400px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(200px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a {
  text-decoration: none;
  color: #fff;
}
#forkongithub>div:hover {
    background: #c11;
    color: #fff;
}
#forkongithub .contributors {
  font-size: 0.75rem;
  background: rgba(255,255,255,0.2);
  line-height: 1.2;
  padding: 0.1em;
}
#forkongithub>div::before,#forkongithub>div::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub>div::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
#forkongithub img {
  width: 1em;
  height: 1em;
  border-radius: 100%;
  vertical-align: middle;
}

@media (max-width: 900px) {
    #forkongithub>div {
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub>div {
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><div><div><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div></div></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL2 Реализация DrawImage</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>Эта статья является продолжением <a href="webgl-3d-orthographic.html">WebGL ортографической 3D</a>.
Если вы не читали её, я рекомендую <a href="webgl-3d-orthographic.html">начать оттуда</a>.
Вы также должны знать, как работают текстуры и координаты текстур, пожалуйста, прочитайте
<a href="webgl-3d-textures.html">WebGL 3D текстуры</a>.</p>
<p>Для реализации большинства игр в 2D требуется всего одна функция для рисования изображения. Конечно, некоторые 2D игры
делают причудливые вещи с линиями и т.д., но если у вас есть только способ нарисовать 2D изображение на экране,
вы можете сделать большинство 2D игр.</p>
<p>Canvas 2D API имеет очень гибкую функцию для рисования изображений, называемую <code class="notranslate" translate="no">drawImage</code>. У неё есть 3 версии:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">ctx.drawImage(image, dstX, dstY);
ctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);
ctx.drawImage(image, srcX, srcY, srcWidth, srcHeight,
                     dstX, dstY, dstWidth, dstHeight);
</code></pre>
<p>Учитывая всё, что вы изучили до сих пор, как бы вы реализовали это в WebGL? Ваше первое
решение может быть генерировать вершины, как это делали некоторые из первых статей на этом сайте.
Отправка вершин в GPU обычно является медленной операцией (хотя есть случаи, когда это будет быстрее).</p>
<p>Здесь вступает в игру вся суть WebGL. Всё дело в творческом написании
шейдера и затем творческом использовании этого шейдера для решения вашей проблемы.</p>
<p>Давайте начнем с первой версии:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">ctx.drawImage(image, x, y);
</code></pre>
<p>Она рисует изображение в позиции <code class="notranslate" translate="no">x, y</code> того же размера, что и изображение.
Чтобы сделать аналогичную WebGL функцию, мы могли бы загрузить вершины для <code class="notranslate" translate="no">x, y</code>, <code class="notranslate" translate="no">x + width, y</code>, <code class="notranslate" translate="no">x, y + height</code>,
и <code class="notranslate" translate="no">x + width, y + height</code>, затем по мере рисования разных изображений в разных местах
мы бы генерировали разные наборы вершин. На самом деле <a href="webgl-fundamentals.html">это именно то, что мы делали в нашей первой
статье</a>.</p>
<p>Гораздо более распространенный способ - это просто использовать единичный квадрат. Мы загружаем один квадрат размером 1 единица. Затем мы
используем <a href="webgl-2d-matrices.html">матричную математику</a> для масштабирования и перемещения этого единичного квадрата так, чтобы
он оказался в нужном месте.</p>
<p>Вот код.</p>
<p>Сначала нам нужен простой вершинный шейдер:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es

in vec4 a_position;
in vec2 a_texcoord;

uniform mat4 u_matrix;
uniform mat4 u_textureMatrix;

out vec2 v_texcoord;

void main() {
   gl_Position = u_matrix * a_position;
   v_texcoord = (u_textureMatrix * vec4(a_texcoord, 0, 1)).xy;
}
</code></pre>
<p>И простой фрагментный шейдер:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es
precision highp float;

in vec2 v_texcoord;

uniform sampler2D texture;

out vec4 outColor;

void main() {
   outColor = texture(texture, v_texcoord);
}
</code></pre>
<p>И теперь функция:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">function drawImage(tex, texWidth, texHeight, dstX, dstY) {
  gl.useProgram(program);

  // Настраиваем атрибуты для квадрата
  gl.bindVertexArray(vao);

  var textureUnit = 0;
  // шейдер, на который мы помещаем текстуру на блок текстуры 0
  gl.uniform1i(textureLocation, textureUnit);

  // Привязываем текстуру к блоку текстуры 0
  gl.activeTexture(gl.TEXTURE0 + textureUnit);
  gl.bindTexture(gl.TEXTURE_2D, tex);

  // эта матрица будет конвертировать из пикселей в пространство отсечения
  var matrix = m4.orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1);

  // перемещаем наш квадрат в dstX, dstY
  matrix = m4.translate(matrix, dstX, dstY, 0);

  // масштабируем наш единичный квадрат
  // с 1 единицы до texWidth, texHeight единиц
  matrix = m4.scale(matrix, texWidth, texHeight, 1);

  // Устанавливаем матрицу.
  gl.uniformMatrix4fv(matrixLocation, false, matrix);

  // рисуем квадрат (2 треугольника, 6 вершин)
  var offset = 0;
  var count = 6;
  gl.drawArrays(gl.TRIANGLES, offset, count);
}
</code></pre>
<p>Давайте загрузим некоторые изображения в текстуры:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">// создает информацию о текстуре { width: w, height: h, texture: tex }
// Текстура начнет с 1x1 пикселей и будет обновлена
// когда изображение загрузится
function loadImageAndCreateTextureInfo(url) {
  var tex = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, tex);

  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

  var textureInfo = {
    width: 1,   // мы не знаем размер, пока он не загрузится
    height: 1,
    texture: tex,
  };
  var img = new Image();
  img.addEventListener('load', function() {
    textureInfo.width = img.width;
    textureInfo.height = img.height;

    gl.bindTexture(gl.TEXTURE_2D, textureInfo.texture);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
    gl.generateMipmap(gl.TEXTURE_2D);
  });

  return textureInfo;
}

var textureInfos = [
  loadImageAndCreateTextureInfo('resources/star.jpg'),
  loadImageAndCreateTextureInfo('resources/leaves.jpg'),
  loadImageAndCreateTextureInfo('resources/keyboard.jpg'),
];
</code></pre>
<p>И давайте нарисуем их в случайных местах:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var drawInfos = [];
var numToDraw = 9;
var speed = 60;
for (var ii = 0; ii &lt; numToDraw; ++ii) {
  var drawInfo = {
    x: Math.random() * gl.canvas.width,
    y: Math.random() * gl.canvas.height,
    dx: Math.random() &gt; 0.5 ? -1 : 1,
    dy: Math.random() &gt; 0.5 ? -1 : 1,
    textureInfo: textureInfos[Math.random() * textureInfos.length | 0],
  };
  drawInfos.push(drawInfo);
}

function update(deltaTime) {
  drawInfos.forEach(function(drawInfo) {
    drawInfo.x += drawInfo.dx * speed * deltaTime;
    drawInfo.y += drawInfo.dy * speed * deltaTime;
    if (drawInfo.x &lt; 0) {
      drawInfo.dx = 1;
    }
    if (drawInfo.x &gt;= gl.canvas.width) {
      drawInfo.dx = -1;
    }
    if (drawInfo.y &lt; 0) {
      drawInfo.dy = 1;
    }
    if (drawInfo.y &gt;= gl.canvas.height) {
      drawInfo.dy = -1;
    }
  });
}

function draw() {
  webglUtils.resizeCanvasToDisplaySize(gl.canvas);

  // Говорим WebGL, как конвертировать из пространства отсечения в пиксели
  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

  // Очищаем холст
  gl.clearColor(0, 0, 0, 0);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

  drawInfos.forEach(function(drawInfo) {
    drawImage(
      drawInfo.textureInfo.texture,
      drawInfo.textureInfo.width,
      drawInfo.textureInfo.height,
      drawInfo.x,
      drawInfo.y);
  });
}

var then = 0;
function render(time) {
  var now = time * 0.001;
  var deltaTime = Math.min(0.1, now - then);
  then = now;

  update(deltaTime);
  draw();

  requestAnimationFrame(render);
}
requestAnimationFrame(render);
</code></pre>
<p>Вы можете увидеть это в действии здесь:</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-01.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-01.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>Обработка версии 2 оригинальной canvas функции <code class="notranslate" translate="no">drawImage</code>:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">ctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);
</code></pre>
<p>Действительно ничем не отличается. Мы просто используем <code class="notranslate" translate="no">dstWidth</code> и <code class="notranslate" translate="no">dstHeight</code> вместо
<code class="notranslate" translate="no">texWidth</code> и <code class="notranslate" translate="no">texHeight</code>.</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">*function drawImage(tex, texWidth, texHeight, dstX, dstY, dstWidth, dstHeight) {
+  if (dstWidth === undefined) {
+    dstWidth = texWidth;
+  }
+
+  if (dstHeight === undefined) {
+    dstHeight = texHeight;
+  }

  gl.useProgram(program);

  // Настраиваем атрибуты для квадрата
  gl.bindVertexArray(vao);

  var textureUnit = 0;
  // шейдер, на который мы помещаем текстуру на блок текстуры 0
  gl.uniform1i(textureLocation, textureUnit);

  // Привязываем текстуру к блоку текстуры 0
  gl.activeTexture(gl.TEXTURE0 + textureUnit);
  gl.bindTexture(gl.TEXTURE_2D, tex);

  // эта матрица будет конвертировать из пикселей в пространство отсечения
  var matrix = m4.orthographic(0, canvas.width, canvas.height, 0, -1, 1);

  // перемещаем наш квадрат в dstX, dstY
  matrix = m4.translate(matrix, dstX, dstY, 0);

  // масштабируем наш единичный квадрат
*  // с 1 единицы до dstWidth, dstHeight единиц
*  matrix = m4.scale(matrix, dstWidth, dstHeight, 1);

  // Устанавливаем матрицу.
  gl.uniformMatrix4fv(matrixLocation, false, matrix);

  // рисуем квадрат (2 треугольника, 6 вершин)
  var offset = 0;
  var count = 6;
  gl.drawArrays(gl.TRIANGLES, offset, count);
}
</code></pre>
<p>Я обновил код для использования разных размеров:</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-02.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-02.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>Так что это было легко. Но что насчет 3-й версии canvas <code class="notranslate" translate="no">drawImage</code>?</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">ctx.drawImage(image, srcX, srcY, srcWidth, srcHeight,
                     dstX, dstY, dstWidth, dstHeight);
</code></pre>
<p>Для выбора части текстуры нам нужно манипулировать координатами текстуры. Как
работают координаты текстуры, было <a href="webgl-3d-textures.html">покрыто в статье о текстурах</a>.
В той статье мы вручную создавали координаты текстуры, что является очень распространенным способом сделать это,
но мы также можем создавать их на лету, и точно так же, как мы манипулируем нашими позициями, используя
матрицу, мы можем аналогично манипулировать координатами текстуры, используя другую матрицу.</p>
<p>Давайте добавим матрицу текстуры в вершинный шейдер и умножим координаты текстуры
на эту матрицу текстуры.</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es

in vec4 a_position;
in vec2 a_texcoord;

uniform mat4 u_matrix;
uniform mat4 u_textureMatrix;

out vec2 v_texcoord;

void main() {
   gl_Position = u_matrix * a_position;
   v_texcoord = (u_textureMatrix * vec4(a_texcoord, 0, 1)).xy;
}
</code></pre>
<p>Теперь нам нужно найти местоположение матрицы текстуры:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var matrixLocation = gl.getUniformLocation(program, &quot;u_matrix&quot;);
var textureMatrixLocation = gl.getUniformLocation(program, &quot;u_textureMatrix&quot;);
</code></pre>
<p>И внутри <code class="notranslate" translate="no">drawImage</code> нам нужно установить её так, чтобы она выбирала часть текстуры, которую мы хотим.
Мы знаем, что координаты текстуры также эффективно являются единичным квадратом, поэтому это очень похоже на
то, что мы уже сделали для позиций.</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">*function drawImage(
*    tex, texWidth, texHeight,
*    srcX, srcY, srcWidth, srcHeight,
*    dstX, dstY, dstWidth, dstHeight) {
+  if (dstX === undefined) {
+    dstX = srcX;
+    srcX = 0;
+  }
+  if (dstY === undefined) {
+    dstY = srcY;
+    srcY = 0;
+  }
+  if (srcWidth === undefined) {
+    srcWidth = texWidth;
+  }
+  if (srcHeight === undefined) {
+    srcHeight = texHeight;
+  }
  if (dstWidth === undefined) {
*    dstWidth = srcWidth;
+    srcWidth = texWidth;
  }
  if (dstHeight === undefined) {
*    dstHeight = srcHeight;
+    srcHeight = texHeight;
  }

  gl.bindTexture(gl.TEXTURE_2D, tex);

  // эта матрица будет конвертировать из пикселей в пространство отсечения
  var matrix = m4.orthographic(
      0, gl.canvas.clientWidth, gl.canvas.clientHeight, 0, -1, 1);

  // перемещаем наш квадрат в dstX, dstY
  matrix = m4.translate(matrix, dstX, dstY, 0);

  // масштабируем наш единичный квадрат
  // с 1 единицы до dstWidth, dstHeight единиц
  matrix = m4.scale(matrix, dstWidth, dstHeight, 1);

  // Устанавливаем матрицу.
  gl.uniformMatrix4fv(matrixLocation, false, matrix);

+  // Поскольку координаты текстуры идут от 0 до 1
+  // и поскольку наши координаты текстуры уже являются единичным квадратом
+  // мы можем выбрать область текстуры, масштабируя единичный квадрат
+  // вниз
+  var texMatrix = m4.translation(srcX / texWidth, srcY / texHeight, 0);
+  texMatrix = m4.scale(texMatrix, srcWidth / texWidth, srcHeight / texHeight, 1);
+
+  // Устанавливаем матрицу текстуры.
+  gl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);

  // рисуем квадрат (2 треугольника, 6 вершин)
  gl.drawArrays(gl.TRIANGLES, 0, 6);
}
</code></pre>
<p>Я также обновил код для выбора частей текстур. Вот результат:</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-03.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-03.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>В отличие от canvas 2D API, наша WebGL версия обрабатывает случаи, которые canvas 2D <code class="notranslate" translate="no">drawImage</code> не обрабатывает.</p>
<p>Во-первых, мы можем передать отрицательную ширину или высоту для источника или назначения. Отрицательная <code class="notranslate" translate="no">srcWidth</code>
будет выбирать пиксели слева от <code class="notranslate" translate="no">srcX</code>. Отрицательная <code class="notranslate" translate="no">dstWidth</code> будет рисовать слева от <code class="notranslate" translate="no">dstX</code>.
В canvas 2D API это ошибки в лучшем случае или неопределенное поведение в худшем.</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-04.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-04.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>Другое - поскольку мы используем матрицу, мы можем делать <a href="webgl-2d-matrices.html">любую матричную математику, которую хотим</a>.</p>
<p>Например, мы могли бы повернуть координаты текстуры вокруг центра текстуры.</p>
<p>Изменяя код матрицы текстуры на это:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">*  // точно как 2d матрица проекции, кроме как в пространстве текстуры (0 до 1)
*  // вместо пространства отсечения. Эта матрица помещает нас в пространство пикселей.
*  var texMatrix = m4.scaling(1 / texWidth, 1 / texHeight, 1);
*
*  // Нам нужно выбрать место для поворота вокруг
*  // Мы переместимся в середину, повернем, затем вернемся обратно
*  var texMatrix = m4.translate(texMatrix, texWidth * 0.5, texHeight * 0.5, 0);
*  var texMatrix = m4.zRotate(texMatrix, srcRotation);
*  var texMatrix = m4.translate(texMatrix, texWidth * -0.5, texHeight * -0.5, 0);
*
*  // потому что мы в пространстве пикселей
*  // масштаб и перемещение теперь в пикселях
*  var texMatrix = m4.translate(texMatrix, srcX, srcY, 0);
*  var texMatrix = m4.scale(texMatrix, srcWidth, srcHeight, 1);

  // Устанавливаем матрицу текстуры.
  gl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);
</code></pre>
<p>И вот это:</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-05.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-05.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>вы можете увидеть одну проблему, которая заключается в том, что из-за поворота иногда мы видим за
краем текстуры. Поскольку она установлена на <code class="notranslate" translate="no">CLAMP_TO_EDGE</code>, край просто повторяется.</p>
<p>Мы могли бы исправить это, отбрасывая любые пиксели вне диапазона от 0 до 1 внутри шейдера.
<code class="notranslate" translate="no">discard</code> немедленно выходит из шейдера без записи пикселя.</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es
precision highp float;

in vec2 v_texcoord;

uniform sampler2D texture;

out vec4 outColor;

void main() {
+   if (v_texcoord.x &lt; 0.0 ||
+       v_texcoord.y &lt; 0.0 ||
+       v_texcoord.x &gt; 1.0 ||
+       v_texcoord.y &gt; 1.0) {
+     discard;
+   }
   outColor = texture(texture, v_texcoord);
}
</code></pre>
<p>И теперь углы исчезли:</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-06.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-06.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>или, может быть, вы хотели бы использовать сплошной цвет, когда координаты текстуры находятся вне текстуры:</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es
precision highp float;

in vec2 v_texcoord;

uniform sampler2D texture;

out vec4 outColor;

void main() {
   if (v_texcoord.x &lt; 0.0 ||
       v_texcoord.y &lt; 0.0 ||
       v_texcoord.x &gt; 1.0 ||
       v_texcoord.y &gt; 1.0) {
*     outColor = vec4(0, 0, 1, 1); // синий
+     return;
   }
   outColor = texture(texture, v_texcoord);
}
</code></pre>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-07.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-07.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>

</p>
<p>Небо действительно является пределом. Всё зависит от вашего творческого использования шейдеров.</p>
<p>Далее <a href="webgl-2d-matrix-stack.html">мы реализуем стек матриц canvas 2d</a>.</p>
<div class="webgl_bottombar">
<h3>Небольшая оптимизация</h3>
<p>Я не рекомендую эту оптимизацию. Скорее я хочу указать
на более творческое мышление, поскольку WebGL - это всё о творческом использовании функций,
которые он предоставляет.</p>
<p>Вы могли заметить, что мы используем единичный квадрат для наших позиций, и эти позиции
единичного квадрата точно соответствуют нашим координатам текстуры. Как таковые, мы можем использовать позиции
как координаты текстуры.</p>
<pre class="prettyprint showlinemods">
#version 300 es
in vec4 a_position;
-in vec2 a_texcoord;

uniform mat4 u_matrix;
uniform mat4 u_textureMatrix;

out vec2 v_texcoord;

void main() {
   gl_Position &#x3D; u_matrix * a_position;
*   v_texcoord &#x3D; (u_textureMatrix * a_position).xy;
}
</pre>
<p>Теперь мы можем удалить код, который настраивал координаты текстуры, и он будет
работать точно так же, как раньше.</p>
<div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-2d-drawimage-08.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-2d-drawimage-08.html" target="_blank">Нажмите, чтобы открыть в новом окне</a>
</div>


</div> 
    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-2d-drawimage.html" >English</a>
    <option value="/webgl/lessons/de/webgl-2d-drawimage.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-2d-drawimage.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-2d-drawimage.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-2d-drawimage.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/ru/webgl-2d-drawimage.html" selected>Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-2d-drawimage.html" >简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>Основы</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-getting-webgl2.html">Как использовать WebGL2</a></li>
<li><a href="/webgl/lessons/ru/webgl-fundamentals.html">Основы</a></li>
<li><a href="/webgl/lessons/ru/webgl-how-it-works.html">Как это работает</a></li>
<li><a href="/webgl/lessons/ru/webgl-shaders-and-glsl.html">Шейдеры и GLSL</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html">WebGL2 Диаграмма состояния</a></li>
        </ul>
  <li>WebGL2 vs WebGL1</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl2-whats-new.html">Что нового в WebGL2</a></li>
<li><a href="/webgl/lessons/ru/webgl1-to-webgl2.html">Переход с WebGL1 на WebGL2</a></li>
<li><a href="/webgl/lessons/ru/webgl1-to-webgl2-fundamentals.html">Отличия от WebGLFundamentals.org до WebGL2Fundamentals.org</a></li>
        </ul>
  <li>Обработка изображений</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-image-processing.html">Обработка изображений</a></li>
<li><a href="/webgl/lessons/ru/webgl-image-processing-continued.html">Продвинутая обработка изображений</a></li>
        </ul>
  <li>2D трансформации, повороты, масштабирование и матричные операции</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-2d-translation.html">2D Трансляция</a></li>
<li><a href="/webgl/lessons/ru/webgl-2d-rotation.html">2D Вращение</a></li>
<li><a href="/webgl/lessons/ru/webgl-2d-scale.html">2D Масштабирование</a></li>
<li><a href="/webgl/lessons/ru/webgl-2d-matrices.html">2D Матрицы</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-3d-orthographic.html">Ортографическая 3D</a></li>
<li><a href="/webgl/lessons/ru/webgl-3d-perspective.html">3D Перспектива</a></li>
<li><a href="/webgl/lessons/ru/webgl-3d-camera.html">3D - Камеры</a></li>
<li><a href="/webgl/lessons/ru/webgl-matrix-naming.html">3D - Именование матриц</a></li>
        </ul>
  <li>Освещение</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-3d-lighting-directional.html">Направленное освещение</a></li>
<li><a href="/webgl/lessons/ru/webgl-3d-lighting-point.html">Точечное освещение</a></li>
<li><a href="/webgl/lessons/ru/webgl-3d-lighting-spot.html">Прожекторное освещение</a></li>
        </ul>
  <li>Организация и рефакторинг</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-less-code-more-fun.html">Меньше кода, больше удовольствия</a></li>
<li><a href="/webgl/lessons/ru/webgl-drawing-multiple-things.html">Рисование множественных объектов</a></li>
<li><a href="/webgl/lessons/ru/webgl-scene-graph.html">Графы сцен</a></li>
        </ul>
  <li>Геометрия</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-3d-geometry-lathe.html">3D Геометрия - Токарная обработка</a></li>
<li><a href="/webgl/lessons/ru/webgl-load-obj.html">Загрузка .obj файлов</a></li>
<li><a href="/webgl/lessons/ru/webgl-load-obj-w-mtl.html">Загрузка .obj с .mtl файлами</a></li>
        </ul>
  <li>Текстуры</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-3d-textures.html">Текстуры</a></li>
<li><a href="/webgl/lessons/ru/webgl-data-textures.html">Data Textures</a></li>
<li><a href="/webgl/lessons/ru/webgl-2-textures.html">Использование 2 или более текстур</a></li>
<li><a href="/webgl/lessons/ru/webgl-cors-permission.html">Cross Origin Images</a></li>
<li><a href="/webgl/lessons/ru/webgl-3d-perspective-correct-texturemapping.html">Перспективно-корректное наложение текстур</a></li>
<li><a href="/webgl/lessons/ru/webgl-planar-projection-mapping.html">Планарное и перспективное проекционное отображение</a></li>
        </ul>
  <li>Рендеринг в текстуру</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-render-to-texture.html">Рендеринг в текстуру</a></li>
        </ul>
  <li>Тени</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-shadows.html">Тени</a></li>
        </ul>
  <li>Техники</li>
        <ul>
            <li>2D</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-2d-drawimage.html">2D - DrawImage</a></li>
<li><a href="/webgl/lessons/ru/webgl-2d-matrix-stack.html">2D - Стек Матриц</a></li>
<li><a href="/webgl/lessons/ru/webgl-sprites.html">Спрайты</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-cube-maps.html">Кубические карты</a></li>
<li><a href="/webgl/lessons/ru/webgl-environment-maps.html">Карты окружения</a></li>
<li><a href="/webgl/lessons/ru/webgl-skybox.html">Скайбоксы</a></li>
<li><a href="/webgl/lessons/ru/webgl-skinning.html">Скининг</a></li>
<li><a href="/webgl/lessons/ru/webgl-fog.html">Fog</a></li>
<li><a href="/webgl/lessons/ru/webgl-picking.html">Пикинг (клик по объектам)</a></li>
        </ul>
  <li>Текст</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-text-html.html">Текст - HTML</a></li>
<li><a href="/webgl/lessons/ru/webgl-text-canvas2d.html">Текст - Canvas 2D</a></li>
<li><a href="/webgl/lessons/ru/webgl-text-texture.html">Текст - Использование текстуры</a></li>
<li><a href="/webgl/lessons/ru/webgl-text-glyphs.html">Текст - Использование текстуры глифов</a></li>
        </ul>
  <li>GPGPU</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-gpgpu.html">GPGPU</a></li>
        </ul>
        </ul>
  <li>Советы</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-smallest-programs.html">Самые маленькие программы</a></li>
<li><a href="/webgl/lessons/ru/webgl-drawing-without-data.html">Рисование без данных</a></li>
<li><a href="/webgl/lessons/ru/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/ru/webgl-pulling-vertices.html">Вытягивание вершин</a></li>
        </ul>
  <li>Оптимизация</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-indexed-vertices.html">Индексированные вершины (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/ru/webgl-instanced-drawing.html">Инстансинг (Instanced Drawing)</a></li>
        </ul>
  <li>Разное</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-setup-and-installation.html">Настройка и установка</a></li>
<li><a href="/webgl/lessons/ru/webgl-boilerplate.html">Boilerplate</a></li>
<li><a href="/webgl/lessons/ru/webgl-resizing-the-canvas.html">Изменение размера Canvas</a></li>
<li><a href="/webgl/lessons/ru/webgl-animation.html">Анимация</a></li>
<li><a href="/webgl/lessons/ru/webgl-points-lines-triangles.html">Точки, линии и треугольники</a></li>
<li><a href="/webgl/lessons/ru/webgl-multiple-views.html">Множественные виды, множественные canvas</a></li>
<li><a href="/webgl/lessons/ru/webgl-visualizing-the-camera.html">Визуализация камеры</a></li>
<li><a href="/webgl/lessons/ru/webgl-and-alpha.html">WebGL2 и альфа-канал</a></li>
<li><a href="/webgl/lessons/ru/webgl-2d-vs-3d-library.html">2D против 3D библиотек</a></li>
<li><a href="/webgl/lessons/ru/webgl-anti-patterns.html">Анти-паттерны</a></li>
<li><a href="/webgl/lessons/ru/webgl-matrix-vs-math.html">WebGL2 Матрицы против математических матриц</a></li>
<li><a href="/webgl/lessons/ru/webgl-precision-issues.html">Проблемы точности</a></li>
<li><a href="/webgl/lessons/ru/webgl-tips.html#screenshot">Скриншот канваса</a></li>
<li><a href="/webgl/lessons/ru/webgl-tips.html#preservedrawingbuffer">Как не очищать канвас</a></li>
<li><a href="/webgl/lessons/ru/webgl-tips.html#tabindex">Получение ввода с клавиатуры</a></li>
<li><a href="/webgl/lessons/ru/webgl-tips.html#html-background">WebGL2 как фон HTML</a></li>
<li><a href="/webgl/lessons/ru/webgl-cross-platform-issues.html">Cross Platform Issues</a></li>
<li><a href="/webgl/lessons/ru/webgl-qna.html">Вопросы и ответы</a></li>
        </ul>
  <li>Справочник</li>
        <ul>
          <li><a href="/webgl/lessons/ru/webgl-attributes.html">Атрибуты</a></li>
<li><a href="/webgl/lessons/ru/webgl-texture-units.html">Текстурные юниты</a></li>
<li><a href="/webgl/lessons/ru/webgl-framebuffers.html">Framebuffers</a></li>
<li><a href="/webgl/lessons/ru/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/ru/webgl-references.html">Ссылки</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">API документация</a></li>
  <li><a href="https://twgljs.org">TWGL, легковесная библиотека-помощник для WebGL</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">GitHub</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        
<div>Есть предложения или замечания? <a href="https://github.com/gfxfundamentals/webgl2-fundamentals/issues">Создайте issue на GitHub</a>.</div>
  

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webgl2fundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL2 Реализация DrawImage';
            var disqus_title = 'WebGL2 Реализация DrawImage';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webgl2fundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script>
const settings = {
  contribTemplate: "Спасибо <a href=\"${html_url}\"><img src=\"${avatar_url}\"> ${login}</a><br>за <a href=\"https://github.com/${owner}/${repo}/commits?author=${login}\">${contributions} вкладов</a>",
  owner: "gfxfundamentals",
  repo: "webgl2-fundamentals",
};
</script>
<script src="/contributors.js"></script>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js" type="module"></script>
<script>
</script>


</html>



