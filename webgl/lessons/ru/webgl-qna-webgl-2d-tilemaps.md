Title: WebGL 2D тайлмапы
Description: WebGL 2D тайлмапы
TOC: WebGL 2D тайлмапы

## Вопрос:

Я создаю простую 2D веб-игру с типичной тайл-картой и спрайтами.

Особенность в том, что мне нужны плавные элементы управления камерой — как перемещение, так и масштабирование (зум).

Я пробовал и Canvas 2D API, и WebGL, но в обоих случаях не могу избежать артефактов сетки (bleeding grid line artifacts), при этом поддерживая правильное масштабирование.

Если это важно: все мои тайлы размером 1, масштабируются до нужного размера, все координаты — целые числа, и я использую текстуру-атлас.

Вот пример картинки с моим WebGL-кодом, где тонкие красные/белые линии нежелательны:
[![enter image description here][1]][1]

  [1]: https://i.stack.imgur.com/ZziiR.png

Я помню, как писал спрайтовые тайлмапы годами назад на desktop GL, иронично используя похожий код (более или менее эквивалентный тому, что можно сделать с WebGL 2), и там никогда не было таких проблем.

Сейчас думаю попробовать DOM-элементы, но боюсь, что это не будет выглядеть или работать плавно.

## Ответ:

Одно из решений — рисовать тайлы во фрагментном шейдере.

У вас есть карта, скажем, `Uint32Array`. Разбиваете её на единицы по 4 байта каждая. Первые 2 байта — ID тайла, последний байт — флаги.

Когда вы проходите по quad'у для каждого пикселя, вы смотрите в текстуру тайлмапы, какой это тайл, затем используете это для вычисления UV-координат, чтобы получить пиксели этого тайла из текстуры тайлов. Если у вашей текстуры тайлов установлена выборка gl.NEAREST, то bleeding никогда не будет.

Заметьте, что в отличие от традиционных тайлмапов, ID каждого тайла — это X,Y-координата тайла в текстуре тайлов. Другими словами, если ваша текстура тайлов имеет 16x8 тайлов, и вы хотите показать тайл на позиции 7 по горизонтали и 4 по вертикали, то ID этого тайла — 7,4 (первый байт 7, второй байт 4), тогда как в традиционной CPU-системе ID тайла был бы, вероятно, 4*16+7 или 71 (71-й тайл). Можно добавить код в шейдер для более традиционной индексации, но поскольку шейдер всё равно должен конвертировать ID в 2D-координаты текстуры, проще использовать 2D-ID.

{{{example url="../webgl-qna-webgl-2d-tilemaps-example-1.html"}}}

<div class="so">
  <div>Вопрос и цитируемые части взяты по лицензии CC BY-SA 4.0 у
    <a data-href="https://stackoverflow.com/users/2503048">user2503048</a>
    с сайта
    <a data-href="https://stackoverflow.com/questions/53462726">stackoverflow</a>
  </div>
</div> 