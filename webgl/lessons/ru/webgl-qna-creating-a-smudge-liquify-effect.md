Title: Создание эффекта смазывания/жидкости (smudge/liquify)
Description: Создание эффекта смазывания/жидкости (smudge/liquify)
TOC: Создание эффекта смазывания/жидкости (smudge/liquify)

## Вопрос:

Я пытаюсь найти информацию или примеры, которые можно использовать для создания эффекта смазывания/жидкости, который постепенно анимируется обратно к исходному состоянию.

Сначала я рассматривал вариант с использованием three.js или pixi.js для рендеринга текста, а затем с помощью событий мыши и ray casting вытягивать меш из позиции. Ближе всего, что я нашёл — это:

https://codepen.io/shshaw/pen/qqVgbg
    
    let renderer = PIXI.autoDetectRenderer(window.innerWidth,
    window.innerHeight, { transparent: true });

Думаю, в идеале я бы рендерил текст как изображение, а затем применял бы эффект смазывания к пикселям, которые медленно возвращались бы к исходному состоянию. Похоже на это:

http://www.duhaihang.com/#/work/

Думаю, мне нужен кастомный GLSL-шейдер и какой-то буфер для хранения исходного и текущего состояния пикселей изображения.

Любая помощь или направление будет очень полезно.

## Ответ:

Оба варианта довольно прямолинейны.

Первый, как вы и сказали, — делаете меш (сетку) вершин, рисующую плоскость. Накладываете текстуру на плоскость, при перемещении мыши добавляете смещение каждой вершине, которую касается мышь. Со временем сбрасываете смещение обратно к 0 (т.е. 0 смещения).

Вот пример: здесь смещается только одна вершина на случайную величину, а не что-то более предсказуемое. В конце я просто сохраняю время, к которому смещение должно исчезнуть, затем в шейдере делаю простой линейный lerp (можно сделать более сложный для эффекта bounce и т.д.). Так почти всё происходит в шейдере.

{{{example url="../webgl-qna-creating-a-smudge-liquify-effect-example-1.html"}}}

Во втором варианте вместо смещения вершин делаете текстуру смещений, со временем сбрасываете это смещение к 0.

Пример затухания можно посмотреть [здесь](https://stackoverflow.com/a/38407507/128511). Если взять этот пример и вместо рисования случайного квадрата рисовать под мышью, а затем использовать эту текстуру как смещение для основного изображения. Под смещением я имею в виду, что обычно вы берёте текстуру во фрагментном шейдере так:

    vec4 color = texture2D(someTexture, someTextureCoords);

Вместо этого вы хотите сместить координаты текстуры с помощью displacement, примерно так:

    // если текстура смещений того же размера, что и основная, можно использовать те же координаты

    // сначала получаем смещение и переводим в диапазон -1 <-> 1
    // используем только R и G каналы, которые станут U и V смещениями для координат текстуры
    vec2 displacement = texture2D(displacementTexture, someTextureCoords).rg * 2. - 1.;

    vec2 uv = someTextureCoords + displacement * displacementRange;
    vec4 color = texture2d(someTexture, uv);

Вот пример выше, используемый для смещения:

{{{example url="../webgl-qna-creating-a-smudge-liquify-effect-example-2.html"}}}

Осталось только рисовать под мышью, а не в случайном месте:

{{{example url="../webgl-qna-creating-a-smudge-liquify-effect-example-3.html"}}}

Точный эффект из вашего второго примера, похоже, использует какое-то шумовое преобразование displacement. Можно воспользоваться [WebGL Inspector](https://benvanik.github.io/WebGL-Inspector/) или [Shader Editor](https://github.com/spite/ShaderEditorExtension), чтобы посмотреть, что происходит в шейдерах.

[Вот ещё пример](https://codepen.io/greggman/pen/bgXgvr), который создаёт текстуру смещений, смещающую больше к центру, чем к краю.

Пояснение: я не смотрел детали того, как работают ваши примеры, я лишь предполагаю, что они делают что-то *похожее*. Лучший способ узнать, что они реально делают — посмотреть их код и воспользоваться инструментами выше, чтобы заглянуть внутрь. Может быть, они используют не прямое смещение, а, например, нормали как displacement. Может быть, вместо рисования сплошным цветом (2-й и 3-й примеры) или текстурой (4-й пример), они используют процедурный паттерн или экранные координаты для повторяющейся текстуры. Может быть, текстура смещений — отдельная текстура, а есть ещё "mix mask", которую рисуют белым и затухают в чёрный, чтобы определить, сколько displacement применять. В WebGL бесконечно много способов реализовать подобные эффекты.



<div class="so">
  <div>Вопрос и цитируемые части взяты по лицензии CC BY-SA 3.0 у
    <a data-href="https://stackoverflow.com/users/3200896">plexus</a>
    с сайта
    <a data-href="https://stackoverflow.com/questions/42049942">stackoverflow</a>
  </div>
</div> 