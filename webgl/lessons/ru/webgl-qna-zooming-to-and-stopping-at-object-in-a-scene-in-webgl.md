Title: Приближение и остановка у объекта в сцене WebGL
Description: Как реализовать приближение к объекту и остановку перед ним в сцене WebGL
TOC: Приближение и остановка у объекта в сцене WebGL

## Вопрос:

Мы создали WebGL-приложение, которое отображает сцену с несколькими объектами. Всю сцену можно вращать в разных направлениях. Требуется, чтобы пользователь мог приближаться к объекту, но НЕ проходить сквозь него. Я знаю, что такую функциональность можно реализовать с помощью фреймворков вроде Three.js и SceneJs. К сожалению, наше приложение не использует фреймворки. Можно ли реализовать описанное приближение только средствами WebGL? Примечание: object picking нам не подходит, так как пользователь не обязан выбирать объект в сцене. Спасибо за помощь.

## Ответ:

Навскидку:

Во-первых, нужно знать размер каждого объекта в мировом пространстве. Например, если один объект размером 10 единиц, а другой — 100, вероятно, вы захотите находиться на разном расстоянии от них. Под мировым пространством я также имею в виду, что если вы масштабируете объект 10 на 9, то в мире он будет 90 единиц, и снова потребуется другое расстояние.

Обычно размер объекта в локальном пространстве вычисляют по экстентам его вершин. Просто проходите по всем вершинам и отслеживайте минимальные и максимальные значения по x, y и z. Хотите ли вы брать максимальное значение от центра или вычислять реальный центр — решайте сами.

Зная размер, можно вычислить, на каком расстоянии нужно быть, чтобы видеть весь объект. Для стандартной перспективной матрицы можно просто посчитать это в обратную сторону. Если объект 10 единиц, нужно уместить 10 единиц в фрустуме. Обычно берут чуть больше, например, 14 (size * 1.4), чтобы был запас вокруг объекта.

![enter image description here][1]

Известны `halfFovy`, `halfSizeToFitOnScreen`, нужно вычислить `distance`:

    sohcahtoa
    tangent = opposite / adjacent
    opposite = halfsizeToFitOnScreen
    adjacent = distance
    tangent  = Math.tan(halfFovY)

Следовательно:

    tangent = sizeToFitOnScreen / distance
    tangent * distance = sizeToFitOnScreen
    distance = sizeToFitOnScreen / tangent
    distance = sizeToFitOnScreen / Math.tan(halfFovY)

Теперь мы знаем, что камере нужно быть на расстоянии `distance` от объекта. На этом расстоянии вокруг объекта есть целая сфера. Где именно на этой сфере — решать вам. Обычно берут текущее положение камеры и вычисляют направление от объекта к камере:

    direction = normalize(cameraPos - objectPos)

Теперь можно вычислить точку на расстоянии `distance` в этом направлении:

    desiredCameraPosition = direction * distance

Теперь либо ставьте камеру туда с помощью lookAt:

    matrix = lookAt(desiredCameraPosition, objectPosition, up)

Либо плавно перемещайте камеру (lerp) между текущей позицией и новой:

{{{example url="../webgl-qna-zooming-to-and-stopping-at-object-in-a-scene-in-webgl-example-1.html"}}}

  [1]: http://i.stack.imgur.com/0axue.png

<div class="so">
  <div>Вопрос и цитируемые части взяты по лицензии CC BY-SA 3.0 у
    <a data-href="https://stackoverflow.com/users/4730921">jfc615</a>
    с сайта
    <a data-href="https://stackoverflow.com/questions/29353242">stackoverflow</a>
  </div>
</div> 