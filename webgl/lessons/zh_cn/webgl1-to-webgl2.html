<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/zh_cn/webgl1-to-webgl2.md. Do not edited directly -->
<!--
Copyright 2021, GFXFundamentals.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of GFXFundamentals. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="怎样迁移WebGL1到WebGL2">
<meta name="keywords" content="webgl webgl2 graphics">
<meta name="thumbnail" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl1-to-webgl2_zh-cn.jpg">

<meta property="og:title" content="迁移WebGL1到WebGL2">
<meta property="og:type" content="website">
<meta property="og:image" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl1-to-webgl2_zh-cn.jpg">
<meta property="og:description" content="怎样迁移WebGL1到WebGL2">
<meta property="og:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@greggman">
<meta name="twitter:creator" content="@greggman">
<meta name="twitter:domain" content="webgl2fundamentals.org">
<meta name="twitter:title" content="迁移WebGL1到WebGL2">
<meta name="twitter:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html">
<meta name="twitter:description" content="怎样迁移WebGL1到WebGL2">
<meta name="twitter:image:src" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl1-to-webgl2_zh-cn.jpg">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webgl2fundamentals.org/#website",
      "url":"https://webgl2fundamentals.org/",
      "name":"Webgl2Fundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html#primaryimage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl1-to-webgl2_zh-cn.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html#webpage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html",
      "inLanguage":"zh-cn",
      "name":"迁移WebGL1到WebGL2",
      "keywords":"webgl webgl2 graphics programming",
      "isPartOf":{
        "@id":"https://webgl2fundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html#primaryimage"
      }
    }
  ]
}
</script>


<title>迁移WebGL1到WebGL2</title>
<link href="/webgl/lessons/resources/webgl2fundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/lang.css">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css">

  <link rel="alternate" hreflang="en" href="https://webglfundamentals.org/webgl/lessons/webgl1-to-webgl2.html">
  <link rel="alternate" hreflang="de" href="https://webglfundamentals.org/webgl/lessons/de/webgl1-to-webgl2.html">
  <link rel="alternate" hreflang="ja" href="https://webglfundamentals.org/webgl/lessons/ja/webgl1-to-webgl2.html">
  <link rel="alternate" hreflang="ko" href="https://webglfundamentals.org/webgl/lessons/ko/webgl1-to-webgl2.html">
  <link rel="alternate" hreflang="pt-br" href="https://webglfundamentals.org/webgl/lessons/pt-br/webgl1-to-webgl2.html">
  <link rel="alternate" hreflang="zh_cn" href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl1-to-webgl2.html">




</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl1-to-webgl2.html" >English</a>
    <option value="/webgl/lessons/de/webgl1-to-webgl2.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl1-to-webgl2.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl1-to-webgl2.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl1-to-webgl2.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl1-to-webgl2.html" selected>简体中文</a>
</select>


    <a href="#toc">目录</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/zh_cn/">WebGL2Fundamentals.org</a></h1>
<style>
#forkongithub>div {
    background: #000;
    color: #fff;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 1.3rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 400px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(200px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a {
  text-decoration: none;
  color: #fff;
}
#forkongithub>div:hover {
    background: #c11;
    color: #fff;
}
#forkongithub .contributors {
  font-size: 0.75rem;
  background: rgba(255,255,255,0.2);
  line-height: 1.2;
  padding: 0.1em;
}
#forkongithub>div::before,#forkongithub>div::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub>div::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
#forkongithub img {
  width: 1em;
  height: 1em;
  border-radius: 100%;
  vertical-align: middle;
}

@media (max-width: 900px) {
    #forkongithub>div {
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub>div {
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><div><div><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div></div></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>迁移WebGL1到WebGL2</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>WebGL2几乎100%向后兼容WebGL1.
如果你只使用WebGL1的特性，只有两点不同。</p>
<ol>
<li><p>调用<code class="notranslate" translate="no">getContext</code>时，你使用<code class="notranslate" translate="no">&quot;webgl2&quot;</code>代替<code class="notranslate" translate="no">&quot;webgl&quot;</code> </p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var gl = someCanvas.getContext(&quot;webgl2&quot;);
</code></pre><p>注意：没有&quot;experimental-webgl2&quot;。浏览器厂商达成共识，不再有前缀。</p>
</li>
<li><p>许多扩展成为WebGL2的标准部分，所以不再用扩展的方式获得 </p>
<p>例如，顶点数组对象<code class="notranslate" translate="no">OES_vertex_array_object</code>是WebGL2标准特性。例如使用WebGL1你是这样做的 </p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var ext = gl.getExtension(&quot;OES_vertex_array_object&quot;);
if (!ext) {
  // 告诉用户没有此扩展或者使用其他方式
} else {
  var someVAO = ext.createVertexArrayOES();
}
</code></pre><p>使用WebGL2你应该这样写</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var someVAO = gl.createVertexArray();
</code></pre><p>因为它已经存在。</p>
</li>
</ol>
<p>除此之外，所有WebGL1的东西应该都能工作。</p>
<p>要利用一些WebGL2特性的优势，你还是需要做一些改变。</p>
<h2 id="-glsl-300-es">切换到GLSL 300 es</h2>
<p>最大的变化是你应该将着色器升级到GLSL 3.00 ES。着色器第一行需要是</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es
</code></pre><p><strong>注意：必须严格在第一行。不能有注释，不能有空行。</strong></p>
<p>这是错误的</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">// 错误!!!!                +---这有空行
// 错误!!!!                V
var vertexShaderSource = `
#version 300 es
..
`;
</code></pre><p>这也是错误的</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">&lt;!-- 错误!!                   V&lt;- 这有空行--&gt;
&lt;script id=&quot;vs&quot; type=&quot;notjs&quot;&gt;
#version 300 es
...
&lt;/script&gt;
</code></pre><p>这是正确的</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var vertexShaderSource = `#version 300 es
...
`;
</code></pre><p>这也是正确的</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">&lt;script id=&quot;vs&quot; type=&quot;notjs&quot;&gt;#version 300 es
...
&lt;/script&gt;
</code></pre><p>或者你可以让你的着色器编译函数去掉开始的空行。</p>
<h3 id="glsl-300-es-glsl-100-">GLSL 300 es和GLSL 100的不同</h3>
<p>有一些在着色器中要改动的差异，上面已经提到需要在最前面添加版本字符串。</p>
<h4 id="-attribute-in-"><code class="notranslate" translate="no">attribute</code> -&gt; <code class="notranslate" translate="no">in</code></h4>
<p>GLSL 100中这样定义</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">attribute vec4 a_position;
attribute vec2 a_texcoord;
attribute vec3 a_normal;
</code></pre><p>在GLSL 300 es中变成了</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">in vec4 a_position;
in vec2 a_texcoord;
in vec3 a_normal;
</code></pre><h4 id="-varying-in-out-"><code class="notranslate" translate="no">varying</code>变为<code class="notranslate" translate="no">in</code> / <code class="notranslate" translate="no">out</code></h4>
<p>在GLSL 100中，你在顶点着色器和片断着色器中都用varying声明 </p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">varying vec2 v_texcoord;
varying vec3 v_normal;
</code></pre><p>在GLSL 300 es中，顶点着色器的varying变为</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">out vec2 v_texcoord;
out vec3 v_normal;
</code></pre><p>在片断着色器中变为</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">in vec2 v_texcoord;
in vec3 v_normal;
</code></pre><h4 id="-gl_fragcolor-">不再有<code class="notranslate" translate="no">gl_FragColor</code></h4>
<p>在GLSL 100中，通过赋值给内置变量<code class="notranslate" translate="no">gl_FragColor</code>来设置片断着色器的输出。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">gl_FragColor = vec4(1, 0, 0, 1);  // 红色
</code></pre><p>在GLSL 300 es中你声明自己的输出变量并给它赋值。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">out vec4 myOutputColor;

void main() {
   myOutputColor = vec4(1, 0, 0, 1);  // red
}
</code></pre><p>注意：你可以随便定义变量名但是<strong>不能</strong>用<code class="notranslate" translate="no">gl_</code>开头，所以你不能这样定义<code class="notranslate" translate="no">out vec4 gl_FragColor</code></p>
<h4 id="-texture2d-texture-etc-"><code class="notranslate" translate="no">texture2D</code> -&gt; <code class="notranslate" translate="no">texture</code> etc.</h4>
<p>在GLSL 100中，你像这样从纹理中获取颜色</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">uniform sampler2D u_some2DTexture;
uniform samplerCube u_someCubeTexture;

...

vec4 color1 = texture2D(u_some2DTexture, ...);
vec4 color2 = textureCube(u_someCubeTexture, ...);
</code></pre><p>在GLSL 300es中， 纹理函数会自动根据类型判断，所以只使用<code class="notranslate" translate="no">texture</code>即可</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">uniform sampler2D u_some2DTexture;
uniform samplerCube u_someCubeTexture;

...

vec4 color1 = texture(u_some2DTexture, ...);
vec4 color2 = texture(u_someCubeTexture, ...);
</code></pre><h2 id="-">纳入标准的特性</h2>
<p>WebGL1中许多特性是可选扩展。在WebGL2中，以下所有的都是标准特性</p>
<ul>
<li>深度纹理(<a href="https://www.khronos.org/registry/webgl/extensions/WEBGL_depth_texture/">WEBGL_depth_texture</a>)</li>
<li>浮点型纹理(<a href="https://www.khronos.org/registry/webgl/extensions/OES_texture_float/">OES_texture_float</a>/<a href="https://www.khronos.org/registry/webgl/extensions/OES_texture_float_linear/">OES_texture_float_linear</a>)</li>
<li>顶点数组对象(<a href="https://www.khronos.org/registry/webgl/extensions/OES_vertex_array_object/">OES_vertex_array_object</a>)</li>
<li>标准导数(<a href="https://www.khronos.org/registry/webgl/extensions/OES_standard_derivatives/">OES_standard_derivatives</a>)</li>
<li>实例绘制(<a href="https://www.khronos.org/registry/webgl/extensions/ANGLE_instanced_arrays/">ANGLE_instanced_arrays</a>)</li>
<li>UNSIGNED_INT索引(<a href="https://www.khronos.org/registry/webgl/extensions/OES_element_index_uint/">OES_element_index_uint</a>)</li>
<li>设置<code class="notranslate" translate="no">gl_FragDepth</code> (<a href="https://www.khronos.org/registry/webgl/extensions/EXT_frag_depth/">EXT_frag_depth</a>)</li>
<li>混合公式MIN/MAX (<a href="https://www.khronos.org/registry/webgl/extensions/EXT_blend_minmax/">EXT_blend_minmax</a>)</li>
<li>直接纹理LOD获取(<a href="https://www.khronos.org/registry/webgl/extensions/EXT_shader_texture_lod/">EXT_shader_texture_lod</a>)</li>
<li>多种绘制缓冲(<a href="https://www.khronos.org/registry/webgl/extensions/WEBGL_draw_buffers/">WEBGL_draw_buffers</a>)</li>
<li>在顶点着色器中获得纹理</li>
</ul>
<h2 id="-2-">支持非2的幂纹理</h2>
<p>在WebGL1中，不是2的幂大小的纹理不能有mip。
在WebGL2中，限制被去掉了。不是2的幂大小的纹理同样工作 </p>
<h2 id="-">浮点型帧缓冲附加物</h2>
<p>在WebGL1中，检查是否支持渲染浮点型纹理，你需要首先检查是否支持<code class="notranslate" translate="no">OES_texture_float</code>扩展，然后你创建一个浮点型纹理，将它添加到一个帧缓冲，调用
<code class="notranslate" translate="no">gl.checkFramebufferStatus</code>看它是否返回<code class="notranslate" translate="no">gl.FRAMEBUFFER_COMPLETE</code>。</p>
<p>在WebGL2中，你需要检查并启用<code class="notranslate" translate="no">EXT_color_buffer_float</code>否则对于浮点纹理
<code class="notranslate" translate="no">gl.checkFramebufferStatus</code>不会返回<code class="notranslate" translate="no">gl.FRAMEBUFFER_COMPLETE</code>。</p>
<p>注意对于<code class="notranslate" translate="no">HALF_FLOAT</code>帧缓冲也是这样。</p>
<blockquote>
<p>如果你好奇，在WebLG1规范中这是一个<em>bug</em>。WebGL1发布，<code class="notranslate" translate="no">OES_texture_float</code>被添加，
并且被设定的正确使用方式是创建一个纹理，附加给帧缓冲，并检查状态。
之后有人指出根据规范这是不够的因为规范说片断着色器中写入的颜色值总是clamp到0至1之间。
<code class="notranslate" translate="no">EXT_color_buffer_float</code>移除了这个clamp限制，但是因为WebGL已经发布一年，
强制限制会破坏许多网站。对于WebGL2，刚好可以解决，所以现在必须启用<code class="notranslate" translate="no">EXT_color_buffer_float</code>
来使用浮点纹理作为帧缓冲的附加物。</p>
<p>注意据我所知，截止2017年3月，很少有移动设备支持渲染浮点纹理。</p>
</blockquote>
<h2 id="-">顶点数组对象</h2>
<p>上面的所有特性，我个人认为顶点数组对象是你经常应该使用的。其他任何特性取决于你想做什么，只有顶点数组对象是一个你应该经常使用的特性。</p>
<p>在WebGL1中，没有顶点数组对象，所有和attribute相关的数据都是全局WebGL状态。你可以想象它为 </p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var glState = {
  attributeState: {
    ELEMENT_ARRAY_BUFFER: null,
    attributes: [
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
      { enable: ?, size: ?, type: ?, normalize: ?, stride: ?, offset: ?, buffer: ?, },
    ],
  },
</code></pre><p>   }</p>
<p>调用像<code class="notranslate" translate="no">gl.vertexAttribPointer</code>，<code class="notranslate" translate="no">gl.enableVertexAttribArray</code>和
<code class="notranslate" translate="no">gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ??)</code>会影响全局状态。在绘制你想要绘制的事情之前，你需要设置所有属性，如果你绘制索引数据，你需要设置<code class="notranslate" translate="no">ELEMENT_ARRAY_BUFFER</code>。</p>
<p>使用顶点数组对对象，上边的整个<code class="notranslate" translate="no">attributeState</code>会变为一个<em>顶点数组</em>.</p>
<p>换句话说</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var someVAO = gl.createVertexArray();
</code></pre><p>创建上面<code class="notranslate" translate="no">attributeState</code>的一个新的实例。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">gl.bindVertexArray(someVAO);
</code></pre><p>等同于</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">glState.attributeState = someVAO;
</code></pre><p>这意味着你应该在初始时设置所有attribute。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">// 初始阶段
// 对于每个模型/ 几何体 / ...
  var vao = gl.createVertexArray()
  gl.bindVertexArray(vao);
  // 对于每个attribute
    gl.enableVertexAttribArray(...);
    gl.bindBuffer(gl.ARRAY_BUFFER, bufferForAttribute);
    gl.vertexAttribPointer(...);
  // 如果是索引几何体
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
  gl.bindVertexArray(null);
</code></pre><p>然后在渲染阶段，使用几何体你需要</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">gl.bindVertexArray(vaoForGeometry);
</code></pre><p>WebGL1中在初始化阶段的循环对象会发生在渲染阶段。
这是巨大的速度提升！</p>
<p>但有几点需要注意：</p>
<ol>
<li><p>attribute位置是程序独立的。</p>
<p>如果你在多个程序里要使用相同的几何体考虑手动分配attribute位置。
GLSL 300 es你可以在着色器中这样写</p>
<p>例如：</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">layout(location = 0) in vec4 a_position;
layout(location = 1) in vec2 a_texcoord;
layout(location = 2) in vec3 a_normal;
layout(location = 3) in vec4 a_color;
</code></pre><p>设置4个attributes的位置。</p>
<p>你仍然可以使用WebGL1的方式，通过在调用<code class="notranslate" translate="no">gl.linkProgram</code>之前调用<code class="notranslate" translate="no">gl.bindAttribLocation</code>。</p>
<p>例如：</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">gl.bindAttribLocation(someProgram, 0, &quot;a_position&quot;);
gl.bindAttribLocation(someProgram, 1, &quot;a_texcoord&quot;);
gl.bindAttribLocation(someProgram, 2, &quot;a_normal&quot;);
gl.bindAttribLocation(someProgram, 3, &quot;a_color&quot;);
</code></pre><p>这意味着你使它们在多个着色器程序中共用。如果一个程序不需要所有attribute，他们需要的attribute会分配到相同的位置。</p>
<p>如果你不这样做，对于不同的着色器程序使用相同的几何体你会需要不同的VAO，或者像在WebGL1中一样不使用VAO，在渲染阶段设置attribute，这很慢。</p>
<p>注意：上面的2种方法我倾向于使用<code class="notranslate" translate="no">gl.bindAttribLocation</code>因为在我的代码中将它放在一个位置更简单。<code class="notranslate" translate="no">layout(location = ?)</code>需要存在于所有着色器中，所以不重复做同样的事情，<code class="notranslate" translate="no">gl.bindAttribLocation</code>似乎更好。或许如果我使用着色器生成器就没有区别了。</p>
</li>
<li><p>完成后，始终解除对VAO的绑定</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">gl.bindVertexArray(null);
</code></pre><p>这只是来自我自己的经验，如果上面的<code class="notranslate" translate="no">ELEMENT_ARRAY_BUFFER</code>状态是顶点数组的一部分。</p>
<p>所以，我遇见了这个问题。我创建了一些几何体，然后我创建了一个VAO来存几何体，并设置attribute和<code class="notranslate" translate="no">ELEMENT_ARRAY_BUFFER</code>。然后我创建了另一些几何体。当几何体设置索引时，因为我仍然有之前的 VAO绑定，设置索引影响了前一个绑定<code class="notranslate" translate="no">ELEMENT_ARRAY_BUFFER</code>的前一个VAO。这让我花了几个小时来调试。</p>
<p>所以，我的建议是，如果你完成了，永远不要留下一个绑定的VAO。要么立即绑定下一个你要使用的VAO或者完成绑定到<code class="notranslate" translate="no">null</code></p>
</li>
</ol>
<p>这就是在从WebGL1迁移到WebGL2时我个人觉得需要注意的事项列表。在<a href="webgl2-whats-new.html">WebGL2有什么新内容</a>文章中有更多你可以做的事情。</p>
<div class="webgl_bottombar">
<h3>让WebGL1扩展看起来像WebGL2</h3>
<p>WebGL1中在扩展上的函数在WebGL2中现在在主上下文上。例如在WebGL1中</p>
<pre class="prettyprint">
var ext = gl.getExtension("OES_vertex_array_object");
if (!ext) {
  // tell user they don't have the required extension or work around it
} else {
  var someVAO = ext.createVertexArrayOES();
}
</pre>
<p>
vs 在WebGL2中
</p>
<pre class="prettyprint">
var someVAO = gl.createVertexArray();
</pre>
<p>如你所见，如果你希望代码在WebGL1和WebGL2中都能运行，这会带来一些挑战。</p>
<p>一种解决方法是在初始时将WebGL1扩展复制到WebGL上下文。这种方法余下的代码可以保持不变。示例：</p>
<pre class="prettyprint">
const gl = someCanvas.getContext("webgl");
const haveVAOs = getAndApplyExtension(gl, "OES_vertex_array_object");

function getAndApplyExtension(gl, name) {
  const ext = gl.getExtension(name);
  if (!ext) {
    return null;
  }
  const fnSuffix = name.split("_")[0];
  const enumSuffix = '_' + fnSuffix;
  for (const key in ext) {
    const value = ext[key];
    const isFunc = typeof (value) === 'function';
    const suffix = isFunc ? fnSuffix : enumSuffix;
    let name = key;
    // WEBGL_compressed_texture_s3tc
    // 和WEBGL_compressed_texture_pvrtc不是true
    if (key.endsWith(suffix)) {
      name = key.substring(0, key.length - suffix.length);
    }
    if (gl[name] !== undefined) {
      if (!isFunc && gl[name] !== value) {
        console.warn("conflict:", name, gl[name], value, key);
      }
    } else {
      if (isFunc) {
        gl[name] = function(origFn) {
          return function() {
            return origFn.apply(ext, arguments);
          };
        }(value);
      } else {
        gl[name] = value;
      }
    }
  }
  return ext;
}
</pre>
<p>现在你的代码大部分可以同样工作，像这样</p>
<pre class="prettyprint">
if (haveVAOs) {
  var someVAO = gl.createVertexArray();
  ...
} else {
  ... do whatever for no VAOs.
}
</pre>
<p>替代方法是像这样做</p>
<pre class="prettyprint">
if (haveVAOs) {
  if (isWebGL2)
     someVAO = gl.createVertexArray();
  } else {
     someVAO = vaoExt.createVertexArrayOES();
  }
  ...
} else {
  ... do whatever for no VAOs.
}
</pre>
<p>注意：特别对于顶点数组对象我建议你<a href="https://github.com/greggman/oes-vertex-array-object-polyfill">使用polyfill</a>，
所以任何时候你都能得到它们。VAO大多数设备都提供。少数设备不提供，polyfill会让你的代码保持简单。</p>
</div>

    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl1-to-webgl2.html" >English</a>
    <option value="/webgl/lessons/de/webgl1-to-webgl2.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl1-to-webgl2.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl1-to-webgl2.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl1-to-webgl2.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl1-to-webgl2.html" selected>简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>基础概念</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-getting-webgl2.html">怎样使用WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fundamentals.html">基本原理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-how-it-works.html">如何工作的</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shaders-and-glsl.html">着色器和 GLSL 语言</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html?lang=zh_cn">WebGL2 State Diagram</a></li>
        </ul>
  <li>WebGL2 vs WebGL1</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl2-whats-new.html">WebGL2有什么新内容</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2.html">迁移WebGL1到WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2-fundamentals.html">WebGLFundamentals.org和WebGL2Fundamentals.org的区别</a></li>
        </ul>
  <li>图像处理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-image-processing.html">图像处理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">进一步处理图像</a></li>
        </ul>
  <li>二维平移，旋转，缩放和矩阵运算</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-translation.html">二维平移</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-rotation.html">二维旋转</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-scale.html">二维缩放</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrices.html">二维矩阵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-orthographic.html">三维正射投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective.html">三维透视投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-camera.html">三维相机</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-naming.html">WebGL2 三维矩阵命名</a></li>
        </ul>
  <li>光照</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html">三维方向光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-point.html">点光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">聚光灯</a></li>
        </ul>
  <li>组织和重构</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-less-code-more-fun.html">码少趣多</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-multiple-things.html">绘制多个物体</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-scene-graph.html">场景图</a></li>
        </ul>
  <li>几何</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-geometry-lathe.html">三维几何加工</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj.html">加载 .obj 文件</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj-w-mtl.html">加载带 .mtl 的 .obj 文件</a></li>
        </ul>
  <li>纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-textures.html">纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-data-textures.html">数据纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2-textures.html">使用多个纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cors-permission.html">跨域图像</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">纹理映射的透视纠正</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-planar-projection-mapping.html">平面的和透视的投影映射</a></li>
        </ul>
  <li>渲染到纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-render-to-texture.html">渲染到纹理</a></li>
        </ul>
  <li>阴影</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-shadows.html">阴影</a></li>
        </ul>
  <li>技术</li>
        <ul>
            <li>二维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-drawimage.html">二维 DrawImage</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html">二维矩阵栈</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-sprites.html">精灵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-cube-maps.html">WebGL2 立方体贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-environment-maps.html">WebGL2 环境贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skybox.html">WebGL2 天空盒</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skinning.html">WebGL2 蒙皮</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fog.html">WebGL2 雾</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-picking.html">Picking (clicking on stuff)</a></li>
        </ul>
  <li>文字</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-text-html.html">文字 - HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-canvas2d.html">文字 - 二维 Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-texture.html">文字 - 使用纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-glyphs.html">文字 - 使用字形纹理</a></li>
        </ul>
  <li>GPGPU</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-gpgpu.html">GPGPU</a></li>
        </ul>
        </ul>
  <li>技巧</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-smallest-programs.html">最小的程序</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-without-data.html">Drawing Without Data</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>优化</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-indexed-vertices.html">顶点索引 (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-instanced-drawing.html">实例化绘制</a></li>
        </ul>
  <li>杂项</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-setup-and-installation.html">设置和安装</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-boilerplate.html">样板</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-resizing-the-canvas.html">重置画布尺寸</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-animation.html">Animation</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-points-lines-triangles.html">Points, Lines, and Triangles</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-visualizing-the-camera.html">Visualizing the Camera</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-and-alpha.html">WebGL2 and Alpha</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-vs-3d-library.html">2D vs 3D libraries</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-anti-patterns.html">Anti-Patterns</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-vs-math.html">WebGL2 Matrices vs Math Matrices</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#html-background">Use WebGL2 as Background in HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cross-platform-issues.html">Cross Platform Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-qna.html">Questions and Answers</a></li>
        </ul>
  <li>参考</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-attributes.html">Attributes</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-texture-units.html">Texture Units</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-framebuffers.html">Framebuffers</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-references.html">References</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">API帮助文档</a></li>
  <li><a href="https://twgljs.org">TWGL，一个轻量级WebGL辅助库</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">GitHub</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        
<div>有意见或建议? <a href="https://github.com/gfxfundamentals/webgl2-fundamentals/issues">在GitHub上提issue</a>.</div>
  

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webgl2fundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = '迁移WebGL1到WebGL2';
            var disqus_title = '迁移WebGL1到WebGL2';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webgl2fundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script>
const settings = {
  contribTemplate: "感谢 <a href=\"${html_url}\"><img src=\"${avatar_url}\"> ${login}</a><br>的 <a href=\"https://github.com/${owner}/${repo}/commits?author=${login}\">${contributions} 个贡献</a>",
  owner: "gfxfundamentals",
  repo: "webgl2-fundamentals",
};
</script>
<script src="/contributors.js"></script>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js" type="module"></script>
<script>
</script>


</html>



