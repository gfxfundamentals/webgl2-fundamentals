<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/zh_cn/webgl-text-glyphs.md. Do not edited directly -->
<!--
Copyright 2021, GFXFundamentals.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of GFXFundamentals. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="如何使用一个字形纹理显示文字">
<meta name="keywords" content="webgl webgl2 graphics">
<meta name="thumbnail" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-text-glyphs_zh-cn.jpg">

<meta property="og:title" content="WebGL2 文字 - 使用字形纹理">
<meta property="og:type" content="website">
<meta property="og:image" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-text-glyphs_zh-cn.jpg">
<meta property="og:description" content="如何使用一个字形纹理显示文字">
<meta property="og:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@greggman">
<meta name="twitter:creator" content="@greggman">
<meta name="twitter:domain" content="webgl2fundamentals.org">
<meta name="twitter:title" content="WebGL2 文字 - 使用字形纹理">
<meta name="twitter:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html">
<meta name="twitter:description" content="如何使用一个字形纹理显示文字">
<meta name="twitter:image:src" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-text-glyphs_zh-cn.jpg">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webgl2fundamentals.org/#website",
      "url":"https://webgl2fundamentals.org/",
      "name":"Webgl2Fundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html#primaryimage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-text-glyphs_zh-cn.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html#webpage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html",
      "inLanguage":"zh-cn",
      "name":"WebGL2 文字 - 使用字形纹理",
      "keywords":"webgl webgl2 graphics programming",
      "isPartOf":{
        "@id":"https://webgl2fundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL2 文字 - 使用字形纹理</title>
<link href="/webgl/lessons/resources/webgl2fundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/lang.css">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css">

  <link rel="alternate" hreflang="en" href="https://webglfundamentals.org/webgl/lessons/webgl-text-glyphs.html">
  <link rel="alternate" hreflang="de" href="https://webglfundamentals.org/webgl/lessons/de/webgl-text-glyphs.html">
  <link rel="alternate" hreflang="ja" href="https://webglfundamentals.org/webgl/lessons/ja/webgl-text-glyphs.html">
  <link rel="alternate" hreflang="ko" href="https://webglfundamentals.org/webgl/lessons/ko/webgl-text-glyphs.html">
  <link rel="alternate" hreflang="pt-br" href="https://webglfundamentals.org/webgl/lessons/pt-br/webgl-text-glyphs.html">
  <link rel="alternate" hreflang="zh_cn" href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-text-glyphs.html">




</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-text-glyphs.html" >English</a>
    <option value="/webgl/lessons/de/webgl-text-glyphs.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-text-glyphs.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-text-glyphs.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-text-glyphs.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl-text-glyphs.html" selected>简体中文</a>
</select>


    <a href="#toc">目录</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/zh_cn/">WebGL2Fundamentals.org</a></h1>
<style>
#forkongithub>div {
    background: #000;
    color: #fff;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 1.3rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 400px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(200px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a {
  text-decoration: none;
  color: #fff;
}
#forkongithub>div:hover {
    background: #c11;
    color: #fff;
}
#forkongithub .contributors {
  font-size: 0.75rem;
  background: rgba(255,255,255,0.2);
  line-height: 1.2;
  padding: 0.1em;
}
#forkongithub>div::before,#forkongithub>div::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub>div::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
#forkongithub img {
  width: 1em;
  height: 1em;
  border-radius: 100%;
  vertical-align: middle;
}

@media (max-width: 900px) {
    #forkongithub>div {
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub>div {
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><div><div><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div></div></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL2 文字 - 使用字形纹理</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>此文上接 WebGL 系列文章，上一篇是<a href="webgl-text-texture.html">在 WebGL 中使用纹理渲染文字</a>，
如果没读可以先看那些。</p>
<p>上篇文章中讲到了<a href="webgl-text-texture.html">如何使用纹理在 WebGL 场景中绘制文字</a>，
那个技术非常常用，并且常用在多人游戏角色头顶名称中，由于那个名字很少改变所以很好用。</p>
<p>假如你想在 UI 中绘制很多文字并且经常改变，接着<a href="webgl-text-texture.html">上文</a>
的例子我们可以为每个字母制作一个纹理。让我们修改代码实现。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">+var names = [
+  &quot;anna&quot;,   // 0
+  &quot;colin&quot;,  // 1
+  &quot;james&quot;,  // 2
+  &quot;danny&quot;,  // 3
+  &quot;kalin&quot;,  // 4
+  &quot;hiro&quot;,   // 5
+  &quot;eddie&quot;,  // 6
+  &quot;shu&quot;,    // 7
+  &quot;brian&quot;,  // 8
+  &quot;tami&quot;,   // 9
+  &quot;rick&quot;,   // 10
+  &quot;gene&quot;,   // 11
+  &quot;natalie&quot;,// 12,
+  &quot;evan&quot;,   // 13,
+  &quot;sakura&quot;, // 14,
+  &quot;kai&quot;,    // 15,
+];

// 创建文字纹理，一个字母一个
var textTextures = [
+  &quot;a&quot;,    // 0
+  &quot;b&quot;,    // 1
+  &quot;c&quot;,    // 2
+  &quot;d&quot;,    // 3
+  &quot;e&quot;,    // 4
+  &quot;f&quot;,    // 5
+  &quot;g&quot;,    // 6
+  &quot;h&quot;,    // 7
+  &quot;i&quot;,    // 8
+  &quot;j&quot;,    // 9
+  &quot;k&quot;,    // 10
+  &quot;l&quot;,    // 11
+  &quot;m&quot;,    // 12,
+  &quot;n&quot;,    // 13,
+  &quot;o&quot;,    // 14,
+  &quot;p&quot;,    // 14,
+  &quot;q&quot;,    // 14,
+  &quot;r&quot;,    // 14,
+  &quot;s&quot;,    // 14,
+  &quot;t&quot;,    // 14,
+  &quot;u&quot;,    // 14,
+  &quot;v&quot;,    // 14,
+  &quot;w&quot;,    // 14,
+  &quot;x&quot;,    // 14,
+  &quot;y&quot;,    // 14,
+  &quot;z&quot;,    // 14,
].map(function(name) {
*  var textCanvas = makeTextCanvas(name, 10, 26);
</code></pre><p>然后为名字中每个字母渲染一个矩形而不是原来的只用一个矩形。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">//  绘制文字设置
+// 因为每个字母使用的是相通的属性和程序
+// 我们只需要设置一次
+gl.useProgram(textProgramInfo.program);
+setBuffersAndAttributes(gl, textProgramInfo.attribSetters, textBufferInfo);

textPositions.forEach(function(pos, ndx) {
+  var name = names[ndx];
+
+  // 每个字母
+  for (var ii = 0; ii &lt; name.length; ++ii) {
+    var letter = name.charCodeAt(ii);
+    var letterNdx = letter - &quot;a&quot;.charCodeAt(0);
+
+    // 选择一个字母纹理
+    var tex = textTextures[letterNdx];

    // 使用 &#39;F&#39; 的位置

    // 由于 pos 在视图空间，表示它是一个从眼睛位置出发的一个向量
    // 所以沿着向量朝眼睛方向移动一定距离
    var fromEye = m4.normalize(pos);
    var amountToMoveTowardEye = 150;  // 因为 F 是 150 个单位长
    var viewX = pos[0] - fromEye[0] * amountToMoveTowardEye;
    var viewY = pos[1] - fromEye[1] * amountToMoveTowardEye;
    var viewZ = pos[2] - fromEye[2] * amountToMoveTowardEye;
    var desiredTextScale = -1 / gl.canvas.height;  // 1x1 像素大小
    var scale = viewZ * desiredTextScale;

    var textMatrix = m4.translate(projectionMatrix, viewX, viewY, viewZ);
    textMatrix = m4.scale(textMatrix, tex.width * scale, tex.height * scale, 1);
    +textMatrix = m4.translate(textMatrix, ii, 0, 0);

    // 设置全局变量
    textUniforms.u_texture = tex.texture;
    copyMatrix(textMatrix, textUniforms.u_matrix);
    setUniforms(textProgramInfo.uniformSetters, textUniforms);

    // 绘制文字
    gl.drawElements(gl.TRIANGLES, textBufferInfo.numElements, gl.UNSIGNED_SHORT, 0);
  }
});
</code></pre><p>查看结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-text-glyphs.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-text-glyphs.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>不幸的是它比较慢，例子中并没有体现出来这一点，但是我们绘制了 73 个矩形，
计算了 73 个矩阵并使用了 219 次矩阵乘法运算，一个典型的 UI 可能很容易超过 1000 个字母，
这种方式就会在每一帧需要进行大量计算。</p>
<p>为了解决这个问题通常是使用一个包含所有字母的纹理图集，
我们在<a href="webgl-3d-textures.html#texture-atlas">给立方体 6 各面贴图</a>
的例子中讲到过纹理图集。</p>
<p>我在网上找到了<a href="https://opengameart.org/content/8x8-font-chomps-wacky-worlds-beta">一个简单的开源字体纹理图集</a>
<img class="webgl_center" width="256" height="160" style="image-rendering: pixelated;" src="../../resources/8x8-font.png" /></p>
<p>让我们制作一些可以用来帮助生成位置和纹理坐标的数据</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var fontInfo = {
  letterHeight: 8,
  spaceWidth: 8,
  spacing: -1,
  textureWidth: 64,
  textureHeight: 40,
  glyphInfos: {
    &#39;a&#39;: { x:  0, y:  0, width: 8, },
    &#39;b&#39;: { x:  8, y:  0, width: 8, },
    &#39;c&#39;: { x: 16, y:  0, width: 8, },
    &#39;d&#39;: { x: 24, y:  0, width: 8, },
    &#39;e&#39;: { x: 32, y:  0, width: 8, },
    &#39;f&#39;: { x: 40, y:  0, width: 8, },
    &#39;g&#39;: { x: 48, y:  0, width: 8, },
    &#39;h&#39;: { x: 56, y:  0, width: 8, },
    &#39;i&#39;: { x:  0, y:  8, width: 8, },
    &#39;j&#39;: { x:  8, y:  8, width: 8, },
    &#39;k&#39;: { x: 16, y:  8, width: 8, },
    &#39;l&#39;: { x: 24, y:  8, width: 8, },
    &#39;m&#39;: { x: 32, y:  8, width: 8, },
    &#39;n&#39;: { x: 40, y:  8, width: 8, },
    &#39;o&#39;: { x: 48, y:  8, width: 8, },
    &#39;p&#39;: { x: 56, y:  8, width: 8, },
    &#39;q&#39;: { x:  0, y: 16, width: 8, },
    &#39;r&#39;: { x:  8, y: 16, width: 8, },
    &#39;s&#39;: { x: 16, y: 16, width: 8, },
    &#39;t&#39;: { x: 24, y: 16, width: 8, },
    &#39;u&#39;: { x: 32, y: 16, width: 8, },
    &#39;v&#39;: { x: 40, y: 16, width: 8, },
    &#39;w&#39;: { x: 48, y: 16, width: 8, },
    &#39;x&#39;: { x: 56, y: 16, width: 8, },
    &#39;y&#39;: { x:  0, y: 24, width: 8, },
    &#39;z&#39;: { x:  8, y: 24, width: 8, },
    &#39;0&#39;: { x: 16, y: 24, width: 8, },
    &#39;1&#39;: { x: 24, y: 24, width: 8, },
    &#39;2&#39;: { x: 32, y: 24, width: 8, },
    &#39;3&#39;: { x: 40, y: 24, width: 8, },
    &#39;4&#39;: { x: 48, y: 24, width: 8, },
    &#39;5&#39;: { x: 56, y: 24, width: 8, },
    &#39;6&#39;: { x:  0, y: 32, width: 8, },
    &#39;7&#39;: { x:  8, y: 32, width: 8, },
    &#39;8&#39;: { x: 16, y: 32, width: 8, },
    &#39;9&#39;: { x: 24, y: 32, width: 8, },
    &#39;-&#39;: { x: 32, y: 32, width: 8, },
    &#39;*&#39;: { x: 40, y: 32, width: 8, },
    &#39;!&#39;: { x: 48, y: 32, width: 8, },
    &#39;?&#39;: { x: 56, y: 32, width: 8, },
  },
};
</code></pre><p>然后我们<a href="webgl-3d-textures.html">像之前加载图像一样加载这个纹理</a>。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">// 创建一个纹理
var glyphTex = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, glyphTex);
// 使用 1×1 蓝色像素像素填充纹理
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,
              new Uint8Array([0, 0, 255, 255]));
// 异步加载图像
var image = new Image();
image.src = &quot;resources/8x8-font.png&quot;;
image.addEventListener(&#39;load&#39;, function() {
  // 图像加载完成，将它拷贝到纹理
  gl.bindTexture(gl.TEXTURE_2D, glyphTex);
  gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);
  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA,gl.UNSIGNED_BYTE, image);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
});
</code></pre><p>现在我们有了一个包含字形的纹理，可以在运行时给每个字形创建矩形，这些顶点将使用纹理坐标选择确切的字形。</p>
<p>给定字符串创建顶点。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">function makeVerticesForString(fontInfo, s) {
  var len = s.length;
  var numVertices = len * 6;
  var positions = new Float32Array(numVertices * 2);
  var texcoords = new Float32Array(numVertices * 2);
  var offset = 0;
  var x = 0;
  var maxX = fontInfo.textureWidth;
  var maxY = fontInfo.textureHeight;
  for (var ii = 0; ii &lt; len; ++ii) {
    var letter = s[ii];
    var glyphInfo = fontInfo.glyphInfos[letter];
    if (glyphInfo) {
      var x2 = x + glyphInfo.width;
      var u1 = glyphInfo.x / maxX;
      var v1 = (glyphInfo.y + fontInfo.letterHeight - 1) / maxY;
      var u2 = (glyphInfo.x + glyphInfo.width - 1) / maxX;
      var v2 = glyphInfo.y / maxY;

      // 每个字母 6 个顶点
      positions[offset + 0] = x;
      positions[offset + 1] = 0;
      texcoords[offset + 0] = u1;
      texcoords[offset + 1] = v1;

      positions[offset + 2] = x2;
      positions[offset + 3] = 0;
      texcoords[offset + 2] = u2;
      texcoords[offset + 3] = v1;

      positions[offset + 4] = x;
      positions[offset + 5] = fontInfo.letterHeight;
      texcoords[offset + 4] = u1;
      texcoords[offset + 5] = v2;

      positions[offset + 6] = x;
      positions[offset + 7] = fontInfo.letterHeight;
      texcoords[offset + 6] = u1;
      texcoords[offset + 7] = v2;

      positions[offset + 8] = x2;
      positions[offset + 9] = 0;
      texcoords[offset + 8] = u2;
      texcoords[offset + 9] = v1;

      positions[offset + 10] = x2;
      positions[offset + 11] = fontInfo.letterHeight;
      texcoords[offset + 10] = u2;
      texcoords[offset + 11] = v2;

      x += glyphInfo.width + fontInfo.spacing;
      offset += 12;
    } else {
      // 没有的字母就留一个间距
      x += fontInfo.spaceWidth;
    }
  }

  // 返回用到的 TypedArrays 的 ArrayBufferViews
  return {
    arrays: {
      position: new Float32Array(positions.buffer, 0, offset),
      texcoord: new Float32Array(texcoords.buffer, 0, offset),
    },
    numVertices: offset / 2,
  };
}
</code></pre><p>我们还要手动创建一个 bufferInfo(<a href="webgl-drawing-multiple-things.html">如果你不知道 bufferInfo 是什么可以看看这里</a>)。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">// Manually create a bufferInfo
var textBufferInfo = {
  attribs: {
    a_position: { buffer: gl.createBuffer(), numComponents: 2, },
    a_texcoord: { buffer: gl.createBuffer(), numComponents: 2, },
  },
  numElements: 0,
};
</code></pre><p>然后需要在渲染文字时更新缓冲，我们也让文字动态变化</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">textPositions.forEach(function(pos, ndx) {

  var name = names[ndx];
+  var s = name + &quot;:&quot; + pos[0].toFixed(0) + &quot;,&quot; + pos[1].toFixed(0) + &quot;,&quot; + pos[2].toFixed(0);
+  var vertices = makeVerticesForString(fontInfo, s);
+
+  // 更新缓冲
+  textBufferInfo.attribs.a_position.numComponents = 2;
+  gl.bindBuffer(gl.ARRAY_BUFFER, textBufferInfo.attribs.a_position.buffer);
+  gl.bufferData(gl.ARRAY_BUFFER, vertices.arrays.position, gl.DYNAMIC_DRAW);
+  gl.bindBuffer(gl.ARRAY_BUFFER, textBufferInfo.attribs.a_texcoord.buffer);
+  gl.bufferData(gl.ARRAY_BUFFER, vertices.arrays.texcoord, gl.DYNAMIC_DRAW);

  // 使用 &#39;F&#39; 的位置

  // 由于 pos 在视图空间，表示它是一个从眼睛位置出发的一个向量
  // 所以沿着向量朝眼睛方向移动一定距离
  var fromEye = m4.normalize(pos);
  var amountToMoveTowardEye = 150;  // 因为 F 是 150 个单位长
  var viewX = pos[0] - fromEye[0] * amountToMoveTowardEye;
  var viewY = pos[1] - fromEye[1] * amountToMoveTowardEye;
  var viewZ = pos[2] - fromEye[2] * amountToMoveTowardEye;
  var desiredTextScale = -1 / gl.canvas.height * 2;  // 1x1 像素大小
  var scale = viewZ * desiredTextScale;

  var textMatrix = m4.translate(projectionMatrix, viewX, viewY, viewZ);
  textMatrix = m4.scale(textMatrix, scale, scale, 1);

  // 设置绘制文字
  gl.useProgram(textProgramInfo.program);

  gl.bindVertexArray(textVAO);

  m4.copy(textMatrix, textUniforms.u_matrix);
  webglUtils.setUniforms(textProgramInfo, textUniforms);

  // 绘制文字
  gl.drawArrays(gl.TRIANGLES, 0, vertices.numVertices);
});
</code></pre><p>这是结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-text-glyphs-texture-atlas.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-text-glyphs-texture-atlas.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>这就是使用字形纹理图集的基本原理，还有几个明显值得添加或改进的地方。</p>
<ul>
<li><p>重用相同的序列</p>
<p>当前 <code class="notranslate" translate="no">makeVerticesForString</code> 在每次调用的时候都创建新的 Float32Arrays。
这最终可能会导致垃圾回收停顿。重用相同的序列可能会好一些，如果序列不够大可以放大并保持大小不变。</p>
</li>
<li><p>添加回车支持</p>
<p>检测是否是 <code class="notranslate" translate="no">\n</code> 然后在创建顶点时换行，这样容易制作文字段落。</p>
</li>
<li><p>添加各种格式化支持</p>
<p>如果你想居中或对齐文字就可以添加这个功能。</p>
</li>
<li><p>添加顶点颜色支持</p>
<p>这样就可以对每个字母设置不同的颜色，当然你还需要决定如何改变文字颜色。</p>
</li>
<li><p>考虑在运行时用二维画布创建字形纹理图集</p>
</li>
</ul>
<p>另一个没有讲到的重要的问题是纹理限制了大小但是字体不限，如果你想支持所有 Unicode 编码就需要处理汉语和日语，
阿拉伯语等其他语言。截止 2015 年已经有了超过 110,000 种 Unicode 字形！你可以用纹理适应所有字形，只是没有足够的空间。</p>
<p>操作系统和浏览器解决这个问题的方式是，在使用 GPU 加速时使用字形纹理缓冲。
向上方一样它们可能将字形放在纹理图集中，但是每种字形可能有一个固定大小的空间，
只在纹理中保存最近常用的字形。如果需要绘制的字形不在纹理中，就替换掉最不常用的那个。
当然如果要替换的字形需要绘制的话，就要在绘制后再替换。</p>
<p>另一个可以做的事情，尽管我不推荐，是结合这个技术和<a href="webgl-text-texture.html">上篇中的技术</a>，
可以将字形直接渲染到一个纹理中。</p>
<p>还有一个在 WebGL 中绘制文字的方式就是使用三维文字，例如所有例子中的 &#39;F&#39; 就是一个三维字母。
你需要为每个字母创建一个，三位字母通常用于标题和电影 logo，其他地方很少用。</p>
<p>希望这些涵盖了 WebGL 的文字部分。</p>

    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-text-glyphs.html" >English</a>
    <option value="/webgl/lessons/de/webgl-text-glyphs.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-text-glyphs.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-text-glyphs.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-text-glyphs.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl-text-glyphs.html" selected>简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>基础概念</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-getting-webgl2.html">怎样使用WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fundamentals.html">基本原理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-how-it-works.html">如何工作的</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shaders-and-glsl.html">着色器和 GLSL 语言</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html?lang=zh_cn">WebGL2 State Diagram</a></li>
        </ul>
  <li>WebGL2 vs WebGL1</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl2-whats-new.html">WebGL2有什么新内容</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2.html">迁移WebGL1到WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2-fundamentals.html">WebGLFundamentals.org和WebGL2Fundamentals.org的区别</a></li>
        </ul>
  <li>图像处理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-image-processing.html">图像处理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">进一步处理图像</a></li>
        </ul>
  <li>二维平移，旋转，缩放和矩阵运算</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-translation.html">二维平移</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-rotation.html">二维旋转</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-scale.html">二维缩放</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrices.html">二维矩阵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-orthographic.html">三维正射投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective.html">三维透视投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-camera.html">三维相机</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-naming.html">WebGL2 三维矩阵命名</a></li>
        </ul>
  <li>光照</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html">三维方向光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-point.html">点光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">聚光灯</a></li>
        </ul>
  <li>组织和重构</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-less-code-more-fun.html">码少趣多</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-multiple-things.html">绘制多个物体</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-scene-graph.html">场景图</a></li>
        </ul>
  <li>几何</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-geometry-lathe.html">三维几何加工</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj.html">加载 .obj 文件</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj-w-mtl.html">加载带 .mtl 的 .obj 文件</a></li>
        </ul>
  <li>纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-textures.html">纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-data-textures.html">数据纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2-textures.html">使用多个纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cors-permission.html">跨域图像</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">纹理映射的透视纠正</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-planar-projection-mapping.html">平面的和透视的投影映射</a></li>
        </ul>
  <li>渲染到纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-render-to-texture.html">渲染到纹理</a></li>
        </ul>
  <li>阴影</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-shadows.html">阴影</a></li>
        </ul>
  <li>技术</li>
        <ul>
            <li>二维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-drawimage.html">二维 DrawImage</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html">二维矩阵栈</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-sprites.html">精灵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-cube-maps.html">WebGL2 立方体贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-environment-maps.html">WebGL2 环境贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skybox.html">WebGL2 天空盒</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skinning.html">WebGL2 蒙皮</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fog.html">WebGL2 雾</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-picking.html">Picking (clicking on stuff)</a></li>
        </ul>
  <li>文字</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-text-html.html">文字 - HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-canvas2d.html">文字 - 二维 Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-texture.html">文字 - 使用纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-glyphs.html">文字 - 使用字形纹理</a></li>
        </ul>
  <li>GPGPU</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-gpgpu.html">GPGPU</a></li>
        </ul>
        </ul>
  <li>技巧</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-smallest-programs.html">最小的程序</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-without-data.html">Drawing Without Data</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>优化</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-indexed-vertices.html">顶点索引 (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-instanced-drawing.html">实例化绘制</a></li>
        </ul>
  <li>杂项</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-setup-and-installation.html">设置和安装</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-boilerplate.html">样板</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-resizing-the-canvas.html">重置画布尺寸</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-animation.html">Animation</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-points-lines-triangles.html">Points, Lines, and Triangles</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-visualizing-the-camera.html">Visualizing the Camera</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-and-alpha.html">WebGL2 and Alpha</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-vs-3d-library.html">2D vs 3D libraries</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-anti-patterns.html">Anti-Patterns</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-vs-math.html">WebGL2 Matrices vs Math Matrices</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#html-background">Use WebGL2 as Background in HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cross-platform-issues.html">Cross Platform Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-qna.html">Questions and Answers</a></li>
        </ul>
  <li>参考</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-attributes.html">Attributes</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-texture-units.html">Texture Units</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-framebuffers.html">Framebuffers</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-references.html">References</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">API帮助文档</a></li>
  <li><a href="https://twgljs.org">TWGL，一个轻量级WebGL辅助库</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">GitHub</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        
<div>有意见或建议? <a href="https://github.com/gfxfundamentals/webgl2-fundamentals/issues">在GitHub上提issue</a>.</div>
  

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webgl2fundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL2 文字 - 使用字形纹理';
            var disqus_title = 'WebGL2 文字 - 使用字形纹理';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webgl2fundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script>
const settings = {
  contribTemplate: "感谢 <a href=\"${html_url}\"><img src=\"${avatar_url}\"> ${login}</a><br>的 <a href=\"https://github.com/${owner}/${repo}/commits?author=${login}\">${contributions} 个贡献</a>",
  owner: "gfxfundamentals",
  repo: "webgl2-fundamentals",
};
</script>
<script src="/contributors.js"></script>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js" type="module"></script>
<script>
</script>


</html>



