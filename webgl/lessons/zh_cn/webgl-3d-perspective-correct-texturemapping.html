<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.md. Do not edited directly -->
<!--
Copyright 2021, GFXFundamentals.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of GFXFundamentals. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="W 有什么特殊的地方">
<meta name="keywords" content="webgl webgl2 graphics">
<meta name="thumbnail" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-3d-perspective-correct-texturemapping_zh-cn.jpg">

<meta property="og:title" content="WebGL2 3D 纹理映射的透视纠正">
<meta property="og:type" content="website">
<meta property="og:image" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-3d-perspective-correct-texturemapping_zh-cn.jpg">
<meta property="og:description" content="W 有什么特殊的地方">
<meta property="og:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@greggman">
<meta name="twitter:creator" content="@greggman">
<meta name="twitter:domain" content="webgl2fundamentals.org">
<meta name="twitter:title" content="WebGL2 3D 纹理映射的透视纠正">
<meta name="twitter:url" content="https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">
<meta name="twitter:description" content="W 有什么特殊的地方">
<meta name="twitter:image:src" content="https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-3d-perspective-correct-texturemapping_zh-cn.jpg">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webgl2fundamentals.org/#website",
      "url":"https://webgl2fundamentals.org/",
      "name":"Webgl2Fundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html#primaryimage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/screenshots/webgl-3d-perspective-correct-texturemapping_zh-cn.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html#webpage",
      "url":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html",
      "inLanguage":"zh-cn",
      "name":"WebGL2 3D 纹理映射的透视纠正",
      "keywords":"webgl webgl2 graphics programming",
      "isPartOf":{
        "@id":"https://webgl2fundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL2 3D 纹理映射的透视纠正</title>
<link href="/webgl/lessons/resources/webgl2fundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/lang.css">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css">

  <link rel="alternate" hreflang="en" href="https://webglfundamentals.org/webgl/lessons/webgl-3d-perspective-correct-texturemapping.html">
  <link rel="alternate" hreflang="de" href="https://webglfundamentals.org/webgl/lessons/de/webgl-3d-perspective-correct-texturemapping.html">
  <link rel="alternate" hreflang="ja" href="https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html">
  <link rel="alternate" hreflang="ko" href="https://webglfundamentals.org/webgl/lessons/ko/webgl-3d-perspective-correct-texturemapping.html">
  <link rel="alternate" hreflang="pt-br" href="https://webglfundamentals.org/webgl/lessons/pt-br/webgl-3d-perspective-correct-texturemapping.html">
  <link rel="alternate" hreflang="zh_cn" href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">




</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-3d-perspective-correct-texturemapping.html" >English</a>
    <option value="/webgl/lessons/de/webgl-3d-perspective-correct-texturemapping.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-perspective-correct-texturemapping.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-perspective-correct-texturemapping.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html" selected>简体中文</a>
</select>


    <a href="#toc">目录</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/zh_cn/">WebGL2Fundamentals.org</a></h1>
<style>
#forkongithub>div {
    background: #000;
    color: #fff;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 1.3rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 400px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(200px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a {
  text-decoration: none;
  color: #fff;
}
#forkongithub>div:hover {
    background: #c11;
    color: #fff;
}
#forkongithub .contributors {
  font-size: 0.75rem;
  background: rgba(255,255,255,0.2);
  line-height: 1.2;
  padding: 0.1em;
}
#forkongithub>div::before,#forkongithub>div::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub>div::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
#forkongithub img {
  width: 1em;
  height: 1em;
  border-radius: 100%;
  vertical-align: middle;
}

@media (max-width: 900px) {
    #forkongithub>div {
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub>div {
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><div><div><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div></div></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL2 3D 纹理映射的透视纠正</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>此文上接 WebGL 系列文章，第一个是<a href="webgl-fundamentals.html">基础概念</a>，
这篇文章讲纹理映射的透视纠正，要理解它你可能需要先看看<a href="webgl-3d-perspective.html">透视投影</a>
和<a href="webgl-3d-textures.html">纹理</a>，你也需要知道<a href="webgl-how-it-works.html">可变量以及它的用处</a>，但是我还会简短的介绍一下。</p>
<p>在&quot;<a href="webgl-how-it-works.html">工作原理</a>&quot;中我们讲过了可变量的工作原理，
顶点着色器可以声明可变量并给它赋值，一旦顶点着色器被引用 3 次就会画一个三角形。
绘制这个三角形的每个像素都会调用片断着色器获得像素颜色，
在三个顶点之间的点会得到差之后的可变量。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 600px; height: 400px;" src="/webgl/lessons/resources/fragment-shader-anim.html"></iframe>
  <div class="webgl_center">v_color is interpolated between v0, v1 and v2</div>
</div>

</p>
<p>回到我们的<a href="webgl-fundamentals.html">第一篇文章</a>，在裁剪空间中绘制一个三角形，
没有数学运算，只是传入裁剪空间坐标到一个简单的顶点着色器，像这样</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  #version 300 es

  // 输入到顶点着色器的属性
  // 从缓冲中获取数据
  in vec4 a_position;

  // 所有的着色器都有一个 main 函数
  void main() {

    // gl_Position 是着色器需要设置的一个特殊的变量
    gl_Position = a_position;
  }
</code></pre><p>还有一个简单的片断着色器提供固定的颜色</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  #version 300 es

  // 片断着色器没有默认的精度，
  // 高等精度是个不错的默认值
  precision highp float;

  // 定义一个传递到片段着色器的颜色变量
  out vec4 outColor;

  void main() {
    // 设置颜色变量为红紫色
    outColor = vec4(1, 0, 0.5, 1);
  }
</code></pre><p>让我们在裁剪空间绘制两个矩形，为每个顶点传递<code class="notranslate" translate="no">X</code>, <code class="notranslate" translate="no">Y</code>, <code class="notranslate" translate="no">Z</code>, 和 <code class="notranslate" translate="no">W</code>。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">var positions = [
  -.8, -.8, 0, 1,  // 第一个矩形的第一个三角形
   .8, -.8, 0, 1,
  -.8, -.2, 0, 1,
  -.8, -.2, 0, 1,  // 第一个矩形的第二个三角形
   .8, -.8, 0, 1,
   .8, -.2, 0, 1,

  -.8,  .2, 0, 1,  // 第二个矩形的第一个三角形
   .8,  .2, 0, 1,
  -.8,  .8, 0, 1,
  -.8,  .8, 0, 1,  // 第二个矩形的第二个三角形
   .8,  .2, 0, 1,
   .8,  .8, 0, 1,
];
</code></pre><p>这是结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-clipspace-rectangles.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-clipspace-rectangles.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>再添加一个浮点型可变量，并把它从顶点着色器直接传递到片断着色器</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  #version 300 es

  in vec4 a_position;
+  in float a_brightness;

+  out float v_brightness;

  void main() {
    gl_Position = a_position;

+    // 直接传递亮度到片断着色器
+    v_brightness = a_brightness;
  }
</code></pre><p>在片断着色器中使用可变量设置颜色</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  #version 300 es

  precision highp float;

+  // 顶点着色器的值插值后传入这里
+  in float v_brightness;

   // 定义一个传递到片段着色器的颜色变量
   out vec4 outColor;

  void main() {
*    outColor = vec4(v_brightness, 0, 0, 1);  // 红色
  }
</code></pre><p>我们需要给可变量提供数据，创建一个缓冲放入一些数据，每个顶点一个值，
我们将设置左边亮度为 0，右边亮度为 1。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  // 创建缓冲并放入 12 个亮度值
  var brightnessBuffer = gl.createBuffer();

  // 绑定到 ARRAY_BUFFER
  gl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);

  var brightness = [
    0,  // 第一个矩形的第一个三角形
    1,
    0,
    0,  // 第一个矩形的第二个三角形
    1,
    1,

    0,  // 第二个矩形的第一个三角形
    1,
    0,
    0,  // 第二个矩形的第二个三角形
    1,
    1,
  ];

  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(brightness), gl.STATIC_DRAW);
</code></pre><p>还需要在初始化阶段找到 <code class="notranslate" translate="no">a_brightness</code> 的位置</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  // 找到顶点数据的输入位置
  var positionAttributeLocation = gl.getAttribLocation(program, &quot;a_position&quot;);
+  var brightnessAttributeLocation = gl.getAttribLocation(program, &quot;a_brightness&quot;);
</code></pre><p>然后在渲染阶段设置属性</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  // 启用属性
  gl.enableVertexAttribArray(brightnessAttributeLocation);

  // 绑定位置缓冲
  gl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);

  // 告诉属性如何从缓冲中读取数据
  var size = 1;          // 每次迭代读取一个单位数据
  var type = gl.FLOAT;   // 数据类型是 32 位浮点型
  var normalize = false; // 不用单位化
  var stride = 0;        // 每次迭代需要移动的距离
  var offset = 0;        // 从缓冲的起始处开始
  gl.vertexAttribPointer(
      brightnessAttributeLocation, size, type, normalize, stride, offset);
</code></pre><p>现在渲染后得到会得到两个矩形，左边 <code class="notranslate" translate="no">brightness</code> 是 0 右边是 1，
中间的部分是插值（或可变量）。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-clipspace-rectangles-with-varying.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-clipspace-rectangles-with-varying.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>在<a href="webgl-3d-perspective.html">透视投影的文章</a>中我们知道 WebGL 会将放入 <code class="notranslate" translate="no">gl_Position</code>
的值除以<code class="notranslate" translate="no">gl_Position.w</code>。</p>
<p>在上方的顶点中我们提供的 <code class="notranslate" translate="no">W</code> 值为 <code class="notranslate" translate="no">1</code>，但是我们知道 WebGL 会除以 <code class="notranslate" translate="no">W</code>，
所以做如下修改应该结果不变。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  var mult = 20;
  var positions = [
      -.8,  .8, 0, 1,  // 第一个矩形的第一个三角形
       .8,  .8, 0, 1,
      -.8,  .2, 0, 1,
      -.8,  .2, 0, 1,  // 第一个矩形的第二个三角形
       .8,  .8, 0, 1,
       .8,  .2, 0, 1,

      -.8       , -.2       , 0,    1,  // 第二个矩形的第一个三角形
       .8 * mult, -.2 * mult, 0, mult,
      -.8       , -.8       , 0,    1,
      -.8       , -.8       , 0,    1,  // 第二个矩形的第二个三角形
       .8 * mult, -.2 * mult, 0, mult,
       .8 * mult, -.8 * mult, 0, mult,
  ];
</code></pre><p>如上所示我们将第二个矩形右边的点的 <code class="notranslate" translate="no">X</code> 和 <code class="notranslate" translate="no">Y</code> 都乘以 <code class="notranslate" translate="no">mult</code>，
同时设置 <code class="notranslate" translate="no">W</code> 为 <code class="notranslate" translate="no">mult</code>。由于 WebGL 会除以 <code class="notranslate" translate="no">W</code> 所以我们应该得到相同的结果对么？</p>
<p>这是结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-clipspace-rectangles-with-varying-non-1-w.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-clipspace-rectangles-with-varying-non-1-w.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>注意两个矩形和上一个例子位置相同，事实是 <code class="notranslate" translate="no">X * MULT / MULT(W)</code> 还是 <code class="notranslate" translate="no">X</code>，
<code class="notranslate" translate="no">Y</code> 也一样，但颜色却不同，为什么？</p>
<p>事实是 WebGL 使用 <code class="notranslate" translate="no">W</code> 实现纹理映射或者可变量插值的透视投影。</p>
<p>如果将片断着色器改成这样就更容以看出效果</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">outColor = vec4(fract(v_brightness * 10.), 0, 0, 1);  // 红色
</code></pre><p>将 <code class="notranslate" translate="no">v_brightness</code> 乘以 10 就会是值的范围为 0 到 10，<code class="notranslate" translate="no">fract</code> 会保留小数部分所以结果还是 0 到 1 之间，但是总共是 10 次 0 到 1 了。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-clipspace-rectangles-with-varying-non-1-w-repeat.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-clipspace-rectangles-with-varying-non-1-w-repeat.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>线性插值应该是这样的公式</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no"> result = (1 - t) * a + t * b
</code></pre><p><code class="notranslate" translate="no">t</code> 的范围是 0 到 1，表示 <code class="notranslate" translate="no">a</code> 到 <code class="notranslate" translate="no">b</code> 之间的位置，0 表示在 <code class="notranslate" translate="no">a</code> 点，1 表示在 <code class="notranslate" translate="no">b</code> 点。</p>
<p>可变量经过 WebGL 的插值时使用这个公式</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">          (1 - t) * a / aW + t * b / bW
result =  -----------------------------
             (1 - t) / aW + t / bW
</code></pre><p><code class="notranslate" translate="no">aW</code> 表示 <code class="notranslate" translate="no">a</code> 点的 <code class="notranslate" translate="no">W</code> 值，也就是 <code class="notranslate" translate="no">gl_Position.w</code> 的值，而不一定等于缓冲中的值，
同理 <code class="notranslate" translate="no">bW</code> 是设置在 <code class="notranslate" translate="no">b</code> 点的 <code class="notranslate" translate="no">gl_Position.w</code>。</p>
<p>为什么这个很重要？这有一个简单的纹理，使用<a href="webgl-3d-textures.html">纹理文章</a>的例子，
并调整了 UV，每个面使用整张纹理，是一个 4×4 像素的纹理。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-perspective-correct-cube.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-perspective-correct-cube.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>现在将例子中的顶点着色器做一些修改，手工除以 <code class="notranslate" translate="no">W</code>，只增加了一行代码</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">#version 300 es

in vec4 a_position;
in vec2 a_texcoord;

uniform mat4 u_matrix;

out vec2 v_texcoord;

void main() {
  // 将位置和矩阵相乘
  gl_Position = u_matrix * a_position;

+  // 手工除以 W
+  gl_Position /= gl_Position.w;

  // 将纹理坐标传到片断着色器
  v_texcoord = a_texcoord;
}
</code></pre><p>除以 <code class="notranslate" translate="no">W</code> 意味值 <code class="notranslate" translate="no">gl_Position.w</code> 始终为 1，<code class="notranslate" translate="no">X</code>, <code class="notranslate" translate="no">Y</code>, 和 <code class="notranslate" translate="no">Z</code>
不会有什么影响，因为 WebGL 也会默认做除法，这是结果。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-non-perspective-correct-cube.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-non-perspective-correct-cube.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>我们还是得到了一个立方体，但是纹理变得扭曲了，这是因为没有传入 <code class="notranslate" translate="no">W</code>
WebGL 就不能正确的实现纹理的透视纠正，或者更准确地说，
WebGL 就不能正确的对可变量的插值实现透视。</p>
<p>如果你还记得的话 <code class="notranslate" translate="no">W</code> 就是<a href="webgl-3d-perspective.html">透视矩阵</a>中的 <code class="notranslate" translate="no">Z</code>，
当 <code class="notranslate" translate="no">W</code> 始终为 <code class="notranslate" translate="no">1</code> 时 WebGL 做的就是一个简单的线性插值，
事实上如果你拿着上述的等式</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">          (1 - t) * a / aW + t * b / bW
 result = -----------------------------
             (1 - t) / aW + t / bW
</code></pre><p>设置所有的 <code class="notranslate" translate="no">W</code> 为 1 就会得到</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">          (1 - t) * a / 1 + t * b / 1
result =  ---------------------------
             (1 - t) / 1 + t / 1
</code></pre><p>除以 1 等于什么也没做，所以简化成这样</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">          (1 - t) * a + t * b
result =  -------------------
             (1 - t) + t
</code></pre><p><code class="notranslate" translate="no">(1 - t) + t</code> 当 <code class="notranslate" translate="no">t</code> 从 0 变到 1 跟 <code class="notranslate" translate="no">1</code> 结果是一样的. 例如
<code class="notranslate" translate="no">t</code> 等于 <code class="notranslate" translate="no">.7</code> 则 <code class="notranslate" translate="no">(1 - .7) + .7</code> 等于 <code class="notranslate" translate="no">.3 + .7</code> 等于 <code class="notranslate" translate="no">1</code>。
换句话说，我们可以移除底部，这样我们就剩下</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no"> result = (1 - t) * a + t * b
</code></pre><p>就和上方提到的线性插值一样了。</p>
<p>现在就清楚为什么 WebGL 要使用 4x4 的矩阵和包含 <code class="notranslate" translate="no">X</code>, <code class="notranslate" translate="no">Y</code>, <code class="notranslate" translate="no">Z</code>, 和 <code class="notranslate" translate="no">W</code> 四个值的向量了吧。
<code class="notranslate" translate="no">X</code> 和 <code class="notranslate" translate="no">Y</code> 除以 <code class="notranslate" translate="no">W</code> 得到裁剪空间坐标，<code class="notranslate" translate="no">Z</code> 除以 <code class="notranslate" translate="no">W</code> 也得到裁剪空间的 Z 坐标，<code class="notranslate" translate="no">W</code> 同时还为纹理映射的透视纠正提供了帮助。</p>
<div class="webgl_bottombar">
<h3>二十世纪中叶的游戏机</h3>
<p>
一点小事，Playstation 1 和其他同一时代的游戏机都没有做纹理映射的透视纠正，
根据以上的信息你就能看出为什么路面是这样的了。
</p>
<div class="webgl_center"><img src="../resources/ridge-racer-01.png" style="max-width: 500px;" /></div>
<p></p>
<div class="webgl_center"><img src="../resources/ridge-racer-02.png" style="max-width: 500px;" /></div>
</div>

    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-3d-perspective-correct-texturemapping.html" >English</a>
    <option value="/webgl/lessons/de/webgl-3d-perspective-correct-texturemapping.html" >Deutsch</a>
    <option value="/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-perspective-correct-texturemapping.html" >한국어</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-perspective-correct-texturemapping.html" >Português Brasileiro</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html" selected>简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>基础概念</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-getting-webgl2.html">怎样使用WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fundamentals.html">基本原理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-how-it-works.html">如何工作的</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shaders-and-glsl.html">着色器和 GLSL 语言</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html?lang=zh_cn">WebGL2 State Diagram</a></li>
        </ul>
  <li>WebGL2 vs WebGL1</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl2-whats-new.html">WebGL2有什么新内容</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2.html">迁移WebGL1到WebGL2</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl1-to-webgl2-fundamentals.html">WebGLFundamentals.org和WebGL2Fundamentals.org的区别</a></li>
        </ul>
  <li>图像处理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-image-processing.html">图像处理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">进一步处理图像</a></li>
        </ul>
  <li>二维平移，旋转，缩放和矩阵运算</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-translation.html">二维平移</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-rotation.html">二维旋转</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-scale.html">二维缩放</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrices.html">二维矩阵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-orthographic.html">三维正射投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective.html">三维透视投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-camera.html">三维相机</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-naming.html">WebGL2 三维矩阵命名</a></li>
        </ul>
  <li>光照</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html">三维方向光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-point.html">点光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">聚光灯</a></li>
        </ul>
  <li>组织和重构</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-less-code-more-fun.html">码少趣多</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-multiple-things.html">绘制多个物体</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-scene-graph.html">场景图</a></li>
        </ul>
  <li>几何</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-geometry-lathe.html">三维几何加工</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj.html">加载 .obj 文件</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj-w-mtl.html">加载带 .mtl 的 .obj 文件</a></li>
        </ul>
  <li>纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-textures.html">纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-data-textures.html">数据纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2-textures.html">使用多个纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cors-permission.html">跨域图像</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">纹理映射的透视纠正</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-planar-projection-mapping.html">平面的和透视的投影映射</a></li>
        </ul>
  <li>渲染到纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-render-to-texture.html">渲染到纹理</a></li>
        </ul>
  <li>阴影</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-shadows.html">阴影</a></li>
        </ul>
  <li>技术</li>
        <ul>
            <li>二维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-drawimage.html">二维 DrawImage</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html">二维矩阵栈</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-sprites.html">精灵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-cube-maps.html">WebGL2 立方体贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-environment-maps.html">WebGL2 环境贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skybox.html">WebGL2 天空盒</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skinning.html">WebGL2 蒙皮</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fog.html">WebGL2 雾</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-picking.html">Picking (clicking on stuff)</a></li>
        </ul>
  <li>文字</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-text-html.html">文字 - HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-canvas2d.html">文字 - 二维 Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-texture.html">文字 - 使用纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-glyphs.html">文字 - 使用字形纹理</a></li>
        </ul>
  <li>GPGPU</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-gpgpu.html">GPGPU</a></li>
        </ul>
        </ul>
  <li>技巧</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-smallest-programs.html">最小的程序</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-without-data.html">Drawing Without Data</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>优化</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-indexed-vertices.html">顶点索引 (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-instanced-drawing.html">实例化绘制</a></li>
        </ul>
  <li>杂项</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-setup-and-installation.html">设置和安装</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-boilerplate.html">样板</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-resizing-the-canvas.html">重置画布尺寸</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-animation.html">Animation</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-points-lines-triangles.html">Points, Lines, and Triangles</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-visualizing-the-camera.html">Visualizing the Camera</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-and-alpha.html">WebGL2 and Alpha</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-vs-3d-library.html">2D vs 3D libraries</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-anti-patterns.html">Anti-Patterns</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-vs-math.html">WebGL2 Matrices vs Math Matrices</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#html-background">Use WebGL2 as Background in HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cross-platform-issues.html">Cross Platform Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-qna.html">Questions and Answers</a></li>
        </ul>
  <li>参考</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-attributes.html">Attributes</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-texture-units.html">Texture Units</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-framebuffers.html">Framebuffers</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-references.html">References</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">API帮助文档</a></li>
  <li><a href="https://twgljs.org">TWGL，一个轻量级WebGL辅助库</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl2-fundamentals">GitHub</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        
<div>有意见或建议? <a href="https://github.com/gfxfundamentals/webgl2-fundamentals/issues">在GitHub上提issue</a>.</div>
  

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webgl2fundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL2 3D 纹理映射的透视纠正';
            var disqus_title = 'WebGL2 3D 纹理映射的透视纠正';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webgl2fundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script>
const settings = {
  contribTemplate: "感谢 <a href=\"${html_url}\"><img src=\"${avatar_url}\"> ${login}</a><br>的 <a href=\"https://github.com/${owner}/${repo}/commits?author=${login}\">${contributions} 个贡献</a>",
  owner: "gfxfundamentals",
  repo: "webgl2-fundamentals",
};
</script>
<script src="/contributors.js"></script>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js" type="module"></script>
<script>
</script>


</html>



